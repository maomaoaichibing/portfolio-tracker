<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒä»“æ™ºæŠ• - æˆ‘çš„æŒä»“</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        :root {
            --primary: #1890FF;
            --primary-light: #E6F7FF;
            --rise: #FF4D4F;
            --rise-bg: #FFF1F0;
            --fall: #52C41A;
            --fall-bg: #F6FFED;
            --text-primary: #262626;
            --text-secondary: #595959;
            --text-tertiary: #8C8C8C;
            --bg-page: #F5F5F5;
            --bg-card: #FFFFFF;
            --border-light: #F0F0F0;
            --font-number: 'DIN Alternate', 'Roboto Mono', 'SF Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-page);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }

        /* å¯¼èˆªæ  */
        .navbar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-light);
            padding: 16px 0;
            margin-bottom: 20px;
        }

        .navbar .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand h1 { font-size: 20px; font-weight: 600; }

        .nav-links { display: flex; gap: 8px; }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav-links a:hover {
            color: var(--primary);
            background: var(--primary-light);
        }

        .nav-links a.active {
            color: var(--primary);
            font-weight: 500;
            background: var(--primary-light);
        }

        /* æ€»èµ„äº§å¡ç‰‡ */
        .asset-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            margin-bottom: 20px;
        }

        .asset-summary .label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .asset-summary .total-value {
            font-size: 36px;
            font-weight: 600;
            margin-bottom: 16px;
            font-family: var(--font-number);
        }

        .asset-summary .stats {
            display: flex;
            gap: 32px;
        }

        .asset-summary .stat-item {
            display: flex;
            flex-direction: column;
        }

        .asset-summary .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .asset-summary .stat-value {
            font-size: 18px;
            font-weight: 500;
            font-family: var(--font-number);
        }

        .asset-summary .profit { color: #FFD93D; }
        .asset-summary .loss { color: #B8E6FF; }

        /* å¸‚åœºç­›é€‰ Tab */
        .market-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: var(--bg-card);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
        }

        .market-tabs button {
            padding: 8px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .market-tabs button:hover {
            color: var(--primary);
            background: var(--primary-light);
        }

        .market-tabs button.active {
            background: var(--primary);
            color: white;
            font-weight: 500;
        }

        /* æŒä»“è¡¨æ ¼ */
        .portfolio-table-container {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
        }

        .portfolio-table th {
            background: #FAFAFA;
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-light);
            white-space: nowrap;
        }

        .portfolio-table th.right { text-align: right; }

        .portfolio-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }

        .portfolio-table tr:hover {
            background: #FAFAFA;
        }

        .portfolio-table tr:last-child td {
            border-bottom: none;
        }

        /* è‚¡ç¥¨åç§°åˆ— */
        .stock-name-cell {
            display: flex;
            flex-direction: column;
        }

        .stock-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .stock-code {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .market-tag {
            display: inline-block;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }

        .market-tag.hk { background: #E6F7FF; color: #1890FF; }
        .market-tag.us { background: #F6FFED; color: #52C41A; }
        .market-tag.a { background: #FFF1F0; color: #FF4D4F; }

        /* æ•°å­—åˆ— */
        .number-cell {
            text-align: right;
            font-family: var(--font-number);
        }

        .number-cell .main {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .number-cell .sub {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        /* ç›ˆäºé¢œè‰² */
        .text-rise { color: var(--rise) !important; }
        .text-fall { color: var(--fall) !important; }

        /* å æ¯”æ¡ */
        .ratio-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ratio-bar .bar {
            width: 60px;
            height: 6px;
            background: #F0F0F0;
            border-radius: 3px;
            overflow: hidden;
        }

        .ratio-bar .bar-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
        }

        .ratio-bar .text {
            font-size: 13px;
            color: var(--text-secondary);
            font-family: var(--font-number);
            min-width: 45px;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            background: var(--primary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .empty-state-desc {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        /* æŒ‰é’® */
        .btn-primary {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #096DD9;
            transform: translateY(-1px);
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .portfolio-table {
                display: block;
                overflow-x: auto;
            }
            
            .asset-summary .total-value {
                font-size: 28px;
            }
            
            .asset-summary .stats {
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¯¼èˆªæ  -->
        <nav class="navbar">
            <div class="nav-brand">
                <h1>ğŸ“ˆ æŒä»“æ™ºæŠ•</h1>
            </div>
            <div class="nav-links">
                <a href="index.html" class="active">æˆ‘çš„æŒä»“</a>
                <a href="monitor.html">AIç›‘æ§</a>
                <a href="analysis.html">æ™ºèƒ½åˆ†æ</a>
                <a href="hot-stocks.html">çƒ­é—¨è‚¡ç¥¨</a>
                <a href="agent.html">ğŸ¤– AI Agent</a>
            </div>
        </nav>

        <!-- æ€»èµ„äº§æ¦‚è§ˆ -->
        <div class="asset-summary">
            <div class="label">æ€»èµ„äº§ (HKD)</div>
            <div class="total-value" id="totalAssets">--</div>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-label">ä»Šæ—¥ç›ˆäº</span>
                    <span class="stat-value" id="todayPnl">--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æŒä»“ç›ˆäº</span>
                    <span class="stat-value" id="totalPnl">--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æŒä»“æ•°é‡</span>
                    <span class="stat-value" id="holdingCount">--</span>
                </div>
            </div>
        </div>

        <!-- å¸‚åœºç­›é€‰ -->
        <div class="market-tabs">
            <button class="active" data-market="all" onclick="filterMarket('all')">å…¨éƒ¨</button>
            <button data-market="HK" onclick="filterMarket('HK')">æ¸¯è‚¡</button>
            <button data-market="US" onclick="filterMarket('US')">ç¾è‚¡</button>
            <button data-market="A" onclick="filterMarket('A')">Aè‚¡</button>
        </div>

        <!-- æŒä»“è¡¨æ ¼ -->
        <div class="portfolio-table-container">
            <table class="portfolio-table">
                <thead>
                    <tr>
                        <th>åç§°/ä»£ç </th>
                        <th class="right">å¸‚å€¼/æ•°é‡</th>
                        <th class="right">ç°ä»·/æˆæœ¬</th>
                        <th class="right">ä»Šæ—¥ç›ˆäº</th>
                        <th class="right">æŒä»“ç›ˆäº</th>
                        <th class="right">æŒä»“å æ¯”</th>
                    </tr>
                </thead>
                <tbody id="portfolioTableBody">
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#1890FF" stroke-width="2">
                                    <path d="M12 2v20M2 12h20"/>
                                </svg>
                            </div>
                            <div class="empty-state-title">æš‚æ— æŒä»“</div>
                            <div class="empty-state-desc">ä¸Šä¼ æŒä»“æˆªå›¾ï¼Œå¼€å§‹æ™ºèƒ½ç›‘æ§</div>
                            <button class="btn-primary" onclick="alert('ä¸Šä¼ åŠŸèƒ½å¼€å‘ä¸­')">ä¸Šä¼ æŒä»“</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE_URL = `${window.location.protocol}//${window.location.host}`;
        let portfolioData = [];
        let currentFilter = 'all';

        // æ ¼å¼åŒ–é‡‘é¢
        function formatAmount(amount, currency = 'HKD') {
            if (amount === null || amount === undefined) return '--';
            const num = Number(amount);
            if (Math.abs(num) >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (Math.abs(num) >= 1000) {
                return (num / 1000).toFixed(2) + 'K';
            }
            return num.toFixed(2);
        }

        // æ ¼å¼åŒ–æ•°å­—ï¼ˆå¸¦åƒåˆ†ä½ï¼‰
        function formatNumber(num) {
            if (num === null || num === undefined) return '--';
            return Number(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // è·å–æ¶¨è·Œæ ·å¼
        function getChangeClass(value) {
            const num = Number(value);
            if (num > 0) return 'text-rise';
            if (num < 0) return 'text-fall';
            return '';
        }

        // æ ¼å¼åŒ–æ¶¨è·Œï¼ˆå¸¦+å·ï¼‰
        function formatChange(value) {
            if (value === null || value === undefined) return '--';
            const num = Number(value);
            const sign = num >= 0 ? '+' : '';
            return sign + formatNumber(num);
        }

        // è·å–å¸‚åœºæ ‡ç­¾
        function getMarketTag(market) {
            if (market === 'HK' || market === 'æ¸¯è‚¡') return '<span class="market-tag hk">æ¸¯è‚¡</span>';
            if (market === 'US') return '<span class="market-tag us">ç¾è‚¡</span>';
            if (market === 'A' || market === 'Aè‚¡') return '<span class="market-tag a">Aè‚¡</span>';
            return '';
        }

        // ç­›é€‰å¸‚åœº
        function filterMarket(market) {
            currentFilter = market;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.market-tabs button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.market === market);
            });
            
            renderTable();
        }

        // åŠ è½½æŒä»“æ•°æ®
        async function loadPortfolio() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/portfolio`);
                const data = await response.json();
                
                if (data.portfolio && data.portfolio.length > 0) {
                    portfolioData = data.portfolio.map(item => ({
                        ...item,
                        marketValue: (item.price || 0) * item.shares,
                        pnl: item.price && item.avg_cost ? (item.price - item.avg_cost) * item.shares : 0,
                        pnlPercent: item.avg_cost ? ((item.price - item.avg_cost) / item.avg_cost * 100) : 0,
                        // æ¨¡æ‹Ÿä»Šæ—¥ç›ˆäºï¼ˆå®é™…åº”ä»APIè·å–ï¼‰
                        todayPnl: item.price ? (item.price * 0.02 * item.shares * (Math.random() - 0.5)) : 0
                    }));
                    
                    updateSummary();
                    renderTable();
                }
            } catch (error) {
                console.error('åŠ è½½æŒä»“å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æ±‡æ€»æ•°æ®
        function updateSummary() {
            const totalValue = portfolioData.reduce((sum, item) => sum + item.marketValue, 0);
            const totalPnl = portfolioData.reduce((sum, item) => sum + item.pnl, 0);
            const todayPnl = portfolioData.reduce((sum, item) => sum + item.todayPnl, 0);
            
            document.getElementById('totalAssets').textContent = formatNumber(totalValue);
            
            const todayPnlEl = document.getElementById('todayPnl');
            todayPnlEl.textContent = formatChange(todayPnl);
            todayPnlEl.className = 'stat-value ' + getChangeClass(todayPnl);
            
            const totalPnlEl = document.getElementById('totalPnl');
            totalPnlEl.textContent = formatChange(totalPnl);
            totalPnlEl.className = 'stat-value ' + getChangeClass(totalPnl);
            
            document.getElementById('holdingCount').textContent = portfolioData.length;
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('portfolioTableBody');
            
            // ç­›é€‰æ•°æ®
            let filteredData = portfolioData;
            if (currentFilter !== 'all') {
                filteredData = portfolioData.filter(item => {
                    if (currentFilter === 'HK') return item.market === 'HK' || item.market === 'æ¸¯è‚¡';
                    if (currentFilter === 'US') return item.market === 'US';
                    if (currentFilter === 'A') return item.market === 'A' || item.market === 'Aè‚¡';
                    return true;
                });
            }
            
            // è®¡ç®—æ€»å¸‚å€¼ç”¨äºå æ¯”
            const totalValue = portfolioData.reduce((sum, item) => sum + item.marketValue, 0);
            
            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#1890FF" stroke-width="2">
                                    <path d="M12 2v20M2 12h20"/>
                                </svg>
                            </div>
                            <div class="empty-state-title">æš‚æ— æŒä»“</div>
                            <div class="empty-state-desc">è¯¥å¸‚åœºä¸‹æ²¡æœ‰æŒä»“</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredData.map(item => {
                const ratio = totalValue > 0 ? (item.marketValue / totalValue * 100) : 0;
                
                return `
                    <tr>
                        <td>
                            <div class="stock-name-cell">
                                <div class="stock-name">
                                    ${item.name}
                                    ${getMarketTag(item.market)}
                                </div>
                                <div class="stock-code">${item.symbol}</div>
                            </div>
                        </td>
                        <td class="number-cell">
                            <div class="main">${formatNumber(item.marketValue)}</div>
                            <div class="sub">${item.shares}è‚¡</div>
                        </td>
                        <td class="number-cell">
                            <div class="main">${formatNumber(item.price)}</div>
                            <div class="sub">${formatNumber(item.avg_cost)}</div>
                        </td>
                        <td class="number-cell">
                            <div class="main ${getChangeClass(item.todayPnl)}">${formatChange(item.todayPnl)}</div>
                            <div class="sub ${getChangeClass(item.todayPnl / item.marketValue * 100)}">${formatChange(item.todayPnl / item.marketValue * 100)}%</div>
                        </td>
                        <td class="number-cell">
                            <div class="main ${getChangeClass(item.pnl)}">${formatChange(item.pnl)}</div>
                            <div class="sub ${getChangeClass(item.pnlPercent)}">${formatChange(item.pnlPercent)}%</div>
                        </td>
                        <td>
                            <div class="ratio-bar">
                                <div class="bar">
                                    <div class="bar-fill" style="width: ${Math.min(ratio, 100)}%"></div>
                                </div>
                                <span class="text">${ratio.toFixed(1)}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', loadPortfolio);
    </script>
</body>
</html>
