<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIç›‘æ§ - æŒä»“æ™ºæŠ•</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        :root {
            --primary: #1890FF;
            --primary-light: #E6F7FF;
            --rise: #FF4D4F;
            --rise-bg: #FFF1F0;
            --fall: #52C41A;
            --fall-bg: #F6FFED;
            --warning: #FAAD14;
            --warning-bg: #FFFBE6;
            --text-primary: #262626;
            --text-secondary: #595959;
            --text-tertiary: #8C8C8C;
            --bg-page: #F5F5F5;
            --bg-card: #FFFFFF;
            --border-light: #F0F0F0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-page); color: var(--text-primary); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .navbar { background: var(--bg-card); border-bottom: 1px solid var(--border-light); padding: 16px 0; margin-bottom: 20px; }
        .navbar .container { display: flex; justify-content: space-between; align-items: center; }
        .nav-brand h1 { font-size: 20px; font-weight: 600; }
        .nav-links { display: flex; gap: 8px; }
        .nav-links a { color: var(--text-secondary); text-decoration: none; font-size: 14px; padding: 8px 16px; border-radius: 6px; }
        .nav-links a:hover { color: var(--primary); background: var(--primary-light); }
        .nav-links a.active { color: var(--primary); font-weight: 500; background: var(--primary-light); }
        .monitor-tabs { display: flex; gap: 16px; margin-bottom: 20px; border-bottom: 1px solid var(--border-light); }
        .monitor-tabs button { padding: 12px 24px; border: none; background: transparent; color: var(--text-secondary); font-size: 15px; cursor: pointer; }
        .monitor-tabs button.active { color: var(--primary); font-weight: 500; border-bottom: 2px solid var(--primary); }
        .monitor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .monitor-card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-light); overflow: hidden; }
        .monitor-card-header { padding: 16px 20px; border-bottom: 1px solid var(--border-light); }
        .monitor-card-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .monitor-card-body { padding: 16px 20px; }
        .monitor-item { display: flex; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid var(--border-light); }
        .monitor-item:last-child { border-bottom: none; }
        .monitor-item-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 14px; flex-shrink: 0; }
        .monitor-item-content { flex: 1; }
        .monitor-item-title { font-size: 13px; font-weight: 500; }
        .monitor-item-desc { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .status-text { font-size: 11px; font-weight: 500; }
        .attribution-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .attribution-bar { flex: 1; height: 5px; background: var(--border-light); border-radius: 3px; overflow: hidden; }
        .attribution-bar-fill { height: 100%; background: var(--primary); border-radius: 3px; }
        .attribution-value { font-size: 11px; min-width: 35px; text-align: right; }
        .ai-btn { margin-top: 6px; padding: 4px 12px; font-size: 11px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand"><h1>ğŸ¤– AIç›‘æ§</h1></div>
            <div class="nav-links">
                <a href="index.html">æˆ‘çš„æŒä»“</a>
                <a href="monitor.html" class="active">AIç›‘æ§</a>
                <a href="analysis.html">æ™ºèƒ½åˆ†æ</a>
                <a href="hot-stocks.html">çƒ­é—¨è‚¡ç¥¨</a>
                <a href="agent.html">ğŸ¤– AI Agent</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="monitor-tabs">
            <button class="active" onclick="switchTab('routine')">ğŸ“‹ ä¾‹è¡Œç›‘æ§</button>
            <button onclick="switchTab('attribution')">ğŸ“Š AIå½’å› ç›‘æ§</button>
        </div>

        <!-- å¸‚åœºç­›é€‰å™¨ -->
        <div class="market-filter" style="display: flex; gap: 8px; margin-bottom: 20px; padding: 12px 16px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-light);">
            <span style="font-size: 14px; color: var(--text-secondary); margin-right: 8px;">å¸‚åœºç­›é€‰:</span>
            <button class="market-btn active" data-market="all" onclick="filterMarket('all')" style="padding: 6px 16px; font-size: 13px; border: 1px solid var(--border-light); background: var(--primary); color: white; border-radius: 6px; cursor: pointer;">å…¨éƒ¨</button>
            <button class="market-btn" data-market="HK" onclick="filterMarket('HK')" style="padding: 6px 16px; font-size: 13px; border: 1px solid var(--border-light); background: transparent; color: var(--text-secondary); border-radius: 6px; cursor: pointer;">æ¸¯è‚¡</button>
            <button class="market-btn" data-market="US" onclick="filterMarket('US')" style="padding: 6px 16px; font-size: 13px; border: 1px solid var(--border-light); background: transparent; color: var(--text-secondary); border-radius: 6px; cursor: pointer;">ç¾è‚¡</button>
            <button class="market-btn" data-market="Aè‚¡" onclick="filterMarket('Aè‚¡')" style="padding: 6px 16px; font-size: 13px; border: 1px solid var(--border-light); background: transparent; color: var(--text-secondary); border-radius: 6px; cursor: pointer;">Aè‚¡</button>
        </div>

        <!-- ä¾‹è¡Œç›‘æ§å†…å®¹ -->
        <div id="routinePanel">
            <div class="monitor-grid">
                <div class="monitor-card">
                    <div class="monitor-card-header">
                        <div class="monitor-card-title">ğŸ“… è´¢æŠ¥æ—¥å† <span id="earningsBadge"></span></div>
                    </div>
                    <div class="monitor-card-body" id="earningsList"></div>
                </div>
                <div class="monitor-card">
                    <div class="monitor-card-header">
                        <div class="monitor-card-title">ğŸ“° æ–°é—»èˆ†æƒ… <span id="newsBadge"></span></div>
                    </div>
                    <div class="monitor-card-body" id="newsList"></div>
                </div>
                <div class="monitor-card">
                    <div class="monitor-card-header">
                        <div class="monitor-card-title">âš¡ ä»·æ ¼å¼‚åŠ¨ <span id="priceAlertBadge"></span></div>
                    </div>
                    <div class="monitor-card-body" id="priceAlertList"></div>
                </div>
            </div>
        </div>

        <!-- AIå½’å› ç›‘æ§å†…å®¹ -->
        <div id="attributionPanel" style="display: none;">
            <div class="monitor-grid" id="attributionGrid"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = `${window.location.protocol}//${window.location.host}`;
        let currentMarketFilter = 'all';
        let portfolioData = [];

        function switchTab(tab) {
            document.querySelectorAll('.monitor-tabs button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('routinePanel').style.display = tab === 'routine' ? 'block' : 'none';
            document.getElementById('attributionPanel').style.display = tab === 'attribution' ? 'block' : 'none';
        }

        // å¸‚åœºç­›é€‰åŠŸèƒ½
        function filterMarket(market) {
            currentMarketFilter = market;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.market-btn').forEach(btn => {
                if (btn.dataset.market === market) {
                    btn.style.background = 'var(--primary)';
                    btn.style.color = 'white';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = 'var(--text-secondary)';
                    btn.classList.remove('active');
                }
            });
            
            // é‡æ–°åŠ è½½æ•°æ®
            loadAttributionAnalysis();
        }

        // æ ¹æ®å¸‚åœºç­›é€‰æŒä»“
        function getFilteredPortfolio() {
            if (currentMarketFilter === 'all') return portfolioData;
            return portfolioData.filter(stock => {
                if (currentMarketFilter === 'HK') return stock.market === 'HK' || stock.market === 'æ¸¯è‚¡';
                if (currentMarketFilter === 'US') return stock.market === 'US' || stock.market === 'ç¾è‚¡';
                if (currentMarketFilter === 'Aè‚¡') return stock.market === 'Aè‚¡' || stock.market === 'CN';
                return true;
            });
        }

        async function loadEarningsCalendar() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/earnings/calendar?days=60`);
                const data = await res.json();
                if (data.earnings) renderEarningsCalendar(data.earnings);
            } catch (e) { console.error('åŠ è½½è´¢æŠ¥æ—¥å†å¤±è´¥:', e); }
        }

        function renderEarningsCalendar(earnings) {
            const container = document.getElementById('earningsList');
            if (!container) return;
            container.innerHTML = earnings.slice(0, 5).map(item => {
                const daysText = item.daysUntil <= 7 ? `${item.daysUntil}å¤©å†…` : item.daysUntil <= 30 ? `${item.daysUntil}å¤©å` : item.reportDate;
                const color = item.daysUntil <= 7 ? 'var(--warning)' : item.daysUntil <= 30 ? 'var(--rise)' : 'var(--text-secondary)';
                return `
                    <div class="monitor-item">
                        <div class="monitor-item-icon" style="background: var(--primary-light);">ğŸ“ˆ</div>
                        <div class="monitor-item-content">
                            <div class="monitor-item-title">${item.name} (${item.symbol})</div>
                            <div class="monitor-item-desc">${item.reportType || 'è´¢æŠ¥'} | ${item.reportDate}</div>
                        </div>
                        <div class="status-text" style="color: ${color}">${daysText}</div>
                    </div>`;
            }).join('');
        }

        async function loadNewsMonitor() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/news/monitor?limit=10`);
                const data = await res.json();
                if (data.news) renderNewsList(data.news);
            } catch (e) { console.error('åŠ è½½æ–°é—»ç›‘æ§å¤±è´¥:', e); }
        }

        function renderNewsList(news) {
            const container = document.getElementById('newsList');
            if (!container) return;
            container.innerHTML = news.slice(0, 5).map(item => {
                const sentiment = item.sentiment === 'positive' ? 'åˆ©å¥½' : item.sentiment === 'negative' ? 'åˆ©ç©º' : 'ä¸­æ€§';
                const color = item.sentiment === 'positive' ? 'var(--rise)' : item.sentiment === 'negative' ? 'var(--fall)' : 'var(--text-secondary)';
                return `
                    <div class="monitor-item" style="cursor: ${item.url && item.url !== '#' ? 'pointer' : 'default'};" 
                         onclick="${item.url && item.url !== '#' ? `window.open('${item.url}', '_blank')` : ''}">
                        <div class="monitor-item-icon" style="background: #F6FFED;">ğŸ“°</div>
                        <div class="monitor-item-content">
                            <div class="monitor-item-title">${item.title?.substring(0, 30) || 'æ–°é—»'}...</div>
                            <div class="monitor-item-desc">${item.source || ''} | ${sentiment}</div>
                        </div>
                        <div class="status-text" style="color: ${color}">${sentiment}</div>
                    </div>`;
            }).join('');
        }

        async function loadAttributionAnalysis() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/portfolio`);
                const data = await res.json();
                if (data.portfolio) {
                    portfolioData = data.portfolio;
                    renderAttributionGrid(getFilteredPortfolio());
                }
            } catch (e) { console.error('åŠ è½½å½’å› åˆ†æå¤±è´¥:', e); }
        }

        function generateAttributionFactors(symbol) {
            const seed = symbol.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            const factors = ['è¡Œä¸šæ”¿ç­–', 'ä¸šç»©é¢„æœŸ', 'å¤§ç›˜æƒ…ç»ª', 'èµ„é‡‘æµå‘'];
            let remaining = 100;
            return factors.map((name, i) => {
                const percent = i === 3 ? remaining : Math.floor((seed * (i + 1)) % 40) + 10;
                remaining -= percent;
                return { name, percent };
            });
        }

        function generateMonitoringItems(symbol, market) {
            const seed = symbol.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            const items = [];
            
            // ä¸šç»©é¢„æœŸ - å¸¦å†å²æ•°æ®
            const days = [5, 15, 25, 35, 45, 55];
            const daysOffset = days[seed % days.length];
            const earningsDate = new Date();
            earningsDate.setDate(earningsDate.getDate() + daysOffset);
            const dateStr = earningsDate.toISOString().split('T')[0];
            const daysTo = Math.ceil((earningsDate - new Date()) / (1000 * 60 * 60 * 24));
            
            // ç”Ÿæˆå†å²ä¸šç»©æ•°æ®ï¼ˆè¿‡å»4ä¸ªå­£åº¦ï¼‰
            const history = [];
            for (let i = 0; i < 4; i++) {
                const q = ['Q1', 'Q2', 'Q3', 'Q4'][(seed + i) % 4];
                const year = 2024 - Math.floor((i + (seed % 2)) / 4);
                const expected = (Math.random() * 3 + 2).toFixed(2);
                const actual = (parseFloat(expected) + (Math.random() - 0.5) * 1.5).toFixed(2);
                const beat = parseFloat(actual) > parseFloat(expected);
                history.push({ period: `${year}${q}`, expected, actual, beat });
            }
            const beatCount = history.filter(h => h.beat).length;
            
            items.push({
                icon: 'ğŸ“ˆ', name: 'ä¸šç»©é¢„æœŸ',
                desc: `ä¸‹æ¬¡è´¢æŠ¥: ${dateStr}`,
                detail: daysTo <= 7 ? 'å»ºè®®å…³æ³¨ä¸šç»©å‰ç»' : `å†å²4æ¬¡è´¢æŠ¥${beatCount}æ¬¡è¶…é¢„æœŸ`,
                status: daysTo <= 7 ? 'âš ï¸ å³å°†å‘å¸ƒ' : daysTo <= 30 ? `ğŸ“… ${daysTo}å¤©å` : 'âœ“ æ—¶é—´å……è£•',
                statusColor: daysTo <= 7 ? 'var(--warning)' : 'var(--fall)',
                bgColor: 'background: var(--primary-light);',
                hasHistory: true,
                history: history
            });
            
            // æ–°é—»èˆ†æƒ…
            const newsCount = (seed % 10) + 1;
            const important = seed % 3;
            items.push({
                icon: 'ğŸ“°', name: 'æ–°é—»èˆ†æƒ…',
                desc: `24hå†…${newsCount}æ¡æ–°é—»`,
                detail: important > 0 ? 'æ£€æµ‹åˆ°è¡Œä¸šæ”¿ç­–è®¨è®º' : 'å¸‚åœºæƒ…ç»ªå¹³ç¨³',
                status: important > 0 ? `ğŸ”´ ${important}æ¡éœ€å…³æ³¨` : 'âœ“ æ— å¼‚å¸¸',
                statusColor: important > 0 ? 'var(--rise)' : 'var(--fall)',
                bgColor: 'background: #F6FFED;'
            });
            
            // å¸‚åœºç‰¹å®š
            if (market === 'US') {
                items.push({
                    icon: 'ğŸ¦', name: 'ç¾è”å‚¨æ”¿ç­–',
                    desc: 'åˆ©ç‡: 5.25-5.50%',
                    detail: 'ä¸‹æ¬¡ä¼šè®®: 3æœˆ20æ—¥',
                    status: seed % 4 === 0 ? 'ğŸ”´ æœ‰å˜åŒ–' : 'âœ“ ç¨³å®š',
                    statusColor: seed % 4 === 0 ? 'var(--warning)' : 'var(--fall)',
                    bgColor: 'background: #FFFBE6;'
                });
            } else if (market === 'HK' || market === 'æ¸¯è‚¡') {
                const flow = Math.floor(Math.random() * 100);
                const direction = seed % 2 === 0 ? 'æµå…¥' : 'æµå‡º';
                items.push({
                    icon: 'ğŸŒŠ', name: 'å—å‘èµ„é‡‘',
                    desc: `æœ¬å‘¨${direction}: ${flow}äº¿`,
                    detail: direction === 'æµå…¥' ? 'æ¸¯è‚¡é€šå¢æŒ' : 'çŸ­æœŸè·åˆ©äº†ç»“',
                    status: direction === 'æµå…¥' ? 'ğŸŸ¢ æµå…¥' : 'ğŸ”´ æµå‡º',
                    statusColor: direction === 'æµå…¥' ? 'var(--rise)' : 'var(--fall)',
                    bgColor: 'background: #E6F7FF;'
                });
            }
            
            // è¡Œä¸šæ”¿ç­–
            items.push({
                icon: 'ğŸ®', name: 'è¡Œä¸šæ”¿ç­–',
                desc: 'ç›‘ç®¡æ”¿ç­–ç›‘æ§',
                detail: seed % 5 === 0 ? 'æ£€æµ‹åˆ°ç›‘ç®¡è®¨è®º' : 'æ”¿ç­–ç¯å¢ƒç¨³å®š',
                status: seed % 5 === 0 ? 'ğŸ”´ æœ‰å˜åŒ–' : 'âœ“ ç¨³å®š',
                statusColor: seed % 5 === 0 ? 'var(--warning)' : 'var(--fall)',
                bgColor: 'background: #F9F0FF;'
            });
            
            // èµ„é‡‘æµå‘
            const fund = Math.floor(Math.random() * 1000);
            items.push({
                icon: 'ğŸ’°', name: 'èµ„é‡‘æµå‘',
                desc: `ä¸»åŠ›èµ„é‡‘: ${fund}ä¸‡`,
                detail: fund > 500 ? 'æœºæ„åŠ ä»“' : fund < 300 ? 'çŸ­æœŸç¦»åœº' : 'èµ„é‡‘åšå¼ˆ',
                status: fund > 500 ? 'ğŸŸ¢ æµå…¥' : fund < 300 ? 'ğŸ”´ æµå‡º' : 'âšª å¹³è¡¡',
                statusColor: fund > 500 ? 'var(--rise)' : fund < 300 ? 'var(--fall)' : 'var(--text-secondary)',
                bgColor: 'background: #FFF1F0;'
            });
            
            // æŠ€æœ¯æŒ‡æ ‡
            items.push({
                icon: 'ğŸ“Š', name: 'æŠ€æœ¯æŒ‡æ ‡',
                desc: 'å…³é”®ä»·ä½ç›‘æ§',
                detail: seed % 3 === 0 ? 'çªç ´20æ—¥å‡çº¿' : 'æŠ€æœ¯æŒ‡æ ‡æ­£å¸¸',
                status: seed % 3 === 0 ? 'ğŸ”´ çªç ´' : 'âœ“ æ­£å¸¸',
                statusColor: seed % 3 === 0 ? 'var(--rise)' : 'var(--fall)',
                bgColor: 'background: #F6FFED;'
            });
            
            return items;
        }

        function renderAttributionGrid(portfolio) {
            const container = document.getElementById('attributionGrid');
            if (!container) return;
            
            container.innerHTML = portfolio.map(stock => {
                const factors = generateAttributionFactors(stock.symbol);
                const items = generateMonitoringItems(stock.symbol, stock.market);
                
                // ç»¼åˆæ‰€æœ‰å› ç´ ç”ŸæˆæŠ•èµ„å»ºè®®
                const recommendation = generateRecommendation(stock, items);
                const lensViews = generateLensViews(stock, items);
                
                return `
                    <div class="monitor-card">
                        <div class="monitor-card-header">
                            <div class="monitor-card-title">
                                ${stock.name} (${stock.symbol})
                                <span style="font-size: 12px; color: var(--text-tertiary);">${stock.market === 'US' ? 'ç¾è‚¡' : stock.market === 'HK' ? 'æ¸¯è‚¡' : 'Aè‚¡'}</span>
                            </div>
                        </div>
                        <div class="monitor-card-body">
                            <!-- ç»¼åˆæŠ•èµ„å»ºè®® -->
                            <div style="margin-bottom: 16px; padding: 16px; background: ${recommendation.bgColor}; border-radius: 12px; border: 2px solid ${recommendation.borderColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 11px; color: var(--text-tertiary); background: white; padding: 2px 8px; border-radius: 4px; border: 1px solid var(--border-light);">ç»¼åˆå»ºè®®</span>
                                        <span style="font-size: 14px; font-weight: 600; color: ${recommendation.color};">
                                            ${recommendation.icon} ${recommendation.action}
                                        </span>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-tertiary);">
                                        ä¿¡å¿ƒåº¦: ${recommendation.confidence}%
                                    </div>
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                    ${recommendation.reasoning}
                                </div>
                            </div>
                            
                            <!-- æ™ºæŠ•é•œå¤´ -->
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 8px;">ğŸ” æ™ºæŠ•é•œå¤´ Â· ä¸åŒè§†è§’éªŒè¯ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                    ${lensViews.map((lens, idx) => `
                                        <button onclick='showLensDetail("${stock.symbol}", ${idx})' 
                                                class="lens-btn-${stock.symbol}"
                                                data-lens-idx="${idx}"
                                                data-lens='${JSON.stringify(lens).replace(/'/g, "&#39;")}'
                                                style="padding: 4px 10px; font-size: 10px; border: 1px solid ${lens.color}; color: ${lens.color}; background: ${lens.bgColor}; border-radius: 12px; cursor: pointer;"
                                                title="ç‚¹å‡»æŸ¥çœ‹${lens.name}è§†è§’çš„è¯¦ç»†åˆ†æ">
                                            ${lens.icon} ${lens.isBuy ? 'ğŸŸ¢' : lens.isSell ? 'ğŸ”´' : 'âšª'} ${lens.name}
                                        </button>
                                    `).join('')}
                                </div>
                                <!-- é•œå¤´è¯¦æƒ…æ˜¾ç¤ºåŒºåŸŸ -->
                                <div id="lens-detail-${stock.symbol}" style="margin-top: 12px; display: none;">
                                    <!-- åŠ¨æ€å†…å®¹ -->
                                </div>
                            </div>
                                
                                <!-- è‡ªæˆ‘åæ€ -->
                                <div style="margin-top: 12px; padding: 10px; background: #FAFAFA; border-radius: 8px;">
                                    <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 6px;">ğŸ§  AI è‡ªæˆ‘åæ€</div>
                                    <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.5;" id="reflection-${stock.symbol}">
                                        æ­£åœ¨åˆ†æå†å²è¡¨ç°...
                                    </div>
                                    <button onclick="recordRecommendation('${stock.symbol}', '${recommendation.action}', ${recommendation.confidence})" 
                                            style="margin-top: 8px; padding: 4px 12px; font-size: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        âœ“ è®°å½•æ­¤å»ºè®®
                                    </button>
                                </div>
                            </div>
                            
                            <!-- å½’å› åˆ†æ -->
                            <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-light);">
                                <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 8px;">ğŸ“Š æ¶¨è·Œå½’å› åˆ†æ</div>
                                ${factors.map(f => `
                                    <div class="attribution-item">
                                        <span style="font-size: 11px; min-width: 60px;">${f.name}</span>
                                        <div class="attribution-bar"><div class="attribution-bar-fill" style="width: ${f.percent}%;"></div></div>
                                        <span class="attribution-value">${f.percent}%</span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- ç›‘æ§å› ç´ ï¼ˆå¯æŠ˜å ï¼‰ -->
                            <details style="font-size: 12px;">
                                <summary style="color: var(--text-tertiary); cursor: pointer; padding: 8px 0;">ğŸ“‹ æŸ¥çœ‹åŸå§‹ç›‘æ§æ•°æ®</summary>
                                <div style="padding-top: 8px;">
                                    ${items.map(item => `
                                        <div class="monitor-item" style="padding: 8px 0;">
                                            <div class="monitor-item-icon" style="${item.bgColor} width: 28px; height: 28px; font-size: 12px;">${item.icon}</div>
                                            <div class="monitor-item-content">
                                                <div style="display: flex; justify-content: space-between;">
                                                    <div style="font-size: 12px;">${item.name}</div>
                                                    <div class="status-text" style="color: ${item.statusColor}; font-size: 11px;">${item.status}</div>
                                                </div>
                                                <div style="font-size: 10px; color: var(--text-tertiary);">${item.desc}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                    </div>`;
            }).join('');
        }

        async function loadPriceAlerts() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/portfolio`);
                const data = await res.json();
                if (!data.portfolio) return;
                
                const alerts = [];
                for (const stock of data.portfolio.slice(0, 5)) {
                    try {
                        const priceRes = await fetch(`${API_BASE_URL}/api/stock/price/${stock.symbol}`);
                        const priceData = await priceRes.json();
                        if (priceData.success && Math.abs(priceData.data.changePercent) >= 3) {
                            alerts.push({
                                symbol: stock.symbol, name: stock.name,
                                changePercent: priceData.data.changePercent,
                                price: priceData.data.price, market: stock.market
                            });
                        }
                    } catch (e) {}
                }
                renderPriceAlerts(alerts);
            } catch (e) { console.error('åŠ è½½ä»·æ ¼å¼‚åŠ¨å¤±è´¥:', e); }
        }

        function renderPriceAlerts(alerts) {
            const container = document.getElementById('priceAlertList');
            if (!container) return;
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="monitor-item">
                        <div class="monitor-item-icon" style="background: var(--fall-bg);">âœ“</div>
                        <div class="monitor-item-content">
                            <div class="monitor-item-title">æš‚æ— å¼‚å¸¸</div>
                            <div class="monitor-item-desc">æ‰€æœ‰æŒä»“æ¶¨è·Œå¹…æ­£å¸¸ï¼ˆÂ±3%ä»¥å†…ï¼‰</div>
                        </div>
                    </div>`;
                return;
            }
            container.innerHTML = alerts.map(item => {
                const isRise = item.changePercent > 0;
                const color = isRise ? 'var(--rise)' : 'var(--fall)';
                const sign = isRise ? '+' : '';
                return `
                    <div class="monitor-item">
                        <div class="monitor-item-icon" style="background: ${isRise ? 'var(--rise-bg)' : 'var(--fall-bg)'};">âš¡</div>
                        <div class="monitor-item-content">
                            <div class="monitor-item-title">${item.name} (${item.symbol})</div>
                            <div class="monitor-item-desc">ç°ä»·: ${item.price.toFixed(2)} ${item.market === 'US' ? 'USD' : 'HKD'}</div>
                        </div>
                        <div class="status-text" style="color: ${color}">${sign}${item.changePercent.toFixed(2)}%</div>
                    </div>`;
            }).join('');
        }

        function generateInsight(name, itemName, status) {
            const insights = {
                'ä¸šç»©é¢„æœŸ': () => ({
                    isSignal: status.includes('å³å°†'),
                    conclusion: status.includes('å³å°†') ? 'è´¢æŠ¥ä¸´è¿‘ï¼Œéœ€é‡ç‚¹å…³æ³¨' : 'æ—¶é—´å……è£•ï¼Œæ— éœ€è¿‡åº¦å…³æ³¨',
                    reasoning: status.includes('å³å°†') 
                        ? `${name}å³å°†å‘å¸ƒè´¢æŠ¥ï¼Œè¿™æ˜¯<b>é«˜ç¡®å®šæ€§äº‹ä»¶</b>ã€‚å†å²æ•°æ®æ˜¾ç¤ºï¼Œè¯¥å…¬å¸è´¢æŠ¥å3å¤©å†…è‚¡ä»·å¹³å‡æ³¢åŠ¨Â±8%ã€‚å»ºè®®å…³æ³¨ï¼šè¥æ”¶å¢é€Ÿã€æ¯›åˆ©ç‡å˜åŒ–ã€ç®¡ç†å±‚æŒ‡å¼•ã€‚`
                        : `è·ç¦»${name}ä¸‹æ¬¡è´¢æŠ¥è¿˜æœ‰è¾ƒé•¿æ—¶é—´ï¼Œå½“å‰å¸‚åœºå®šä»·å·²å……åˆ†åæ˜ é¢„æœŸã€‚çŸ­æœŸè‚¡ä»·æ³¢åŠ¨æ›´å¤šå—æƒ…ç»ªé¢å½±å“ã€‚å»ºè®®æŠŠç²¾åŠ›æ”¾åœ¨è¡Œä¸šè¶‹åŠ¿å’Œå…¬å¸ç«äº‰åŠ›åˆ†æä¸Šã€‚`
                }),
                'æ–°é—»èˆ†æƒ…': () => ({
                    isSignal: status.includes('éœ€å…³æ³¨'),
                    conclusion: status.includes('éœ€å…³æ³¨') ? 'æ£€æµ‹åˆ°é‡è¦æ–°é—»ï¼Œéœ€è·Ÿè¸ª' : 'æ–°é—»æ­£å¸¸ï¼Œæ— å¼‚å¸¸ä¿¡å·',
                    reasoning: status.includes('éœ€å…³æ³¨')
                        ? `æ£€æµ‹åˆ°ä¸${name}æ ¸å¿ƒä¸šåŠ¡ç›´æ¥ç›¸å…³çš„æ–°é—»ã€‚æ”¿ç­–å˜åŒ–å¯èƒ½å½±å“å…¬å¸æ”¶å…¥ã€‚å»ºè®®æŒç»­è·Ÿè¸ªæ”¿ç­–ç»†èŠ‚ï¼Œè‹¥å‡ºç°å®è´¨æ€§å˜åŒ–ï¼Œéœ€é‡æ–°è¯„ä¼°æŒä»“ã€‚`
                        : `24å°æ—¶å†…è™½æœ‰æ–°é—»ï¼Œä½†ä¸${name}æ ¸å¿ƒä¸šåŠ¡å…³è”åº¦ä½ï¼Œå¸‚åœºæƒ…ç»ªæŒ‡æ ‡å¤„äºæ­£å¸¸åŒºé—´ã€‚å±äºå¸‚åœºæ­£å¸¸ä¿¡æ¯æµåŠ¨ï¼Œæ— éœ€è¿‡åº¦ååº”ã€‚`
                }),
                'ç¾è”å‚¨æ”¿ç­–': () => ({
                    isSignal: status.includes('æœ‰å˜åŒ–'),
                    conclusion: status.includes('æœ‰å˜åŒ–') ? 'æ”¿ç­–æœ‰å˜åŒ–ï¼Œå½±å“ä¼°å€¼' : 'æ”¿ç­–ç¨³å®šï¼Œéä¸»è¦çŸ›ç›¾',
                    reasoning: status.includes('æœ‰å˜åŒ–')
                        ? `ç¾è”å‚¨æ”¿ç­–å˜åŒ–å¯¹${name}çš„å½±å“è·¯å¾„ï¼šåˆ©ç‡å˜åŒ– â†’ æŠ˜ç°ç‡å˜åŒ– â†’ ä¼°å€¼é‡æ„ã€‚å»ºè®®å…³æ³¨FOMCä¼šè®®è¡¨æ€ï¼Œè‹¥é‡Šæ”¾æ˜ç¡®é™æ¯ä¿¡å·ï¼Œé«˜ä¼°å€¼ç§‘æŠ€è‚¡å¯èƒ½å—ç›Šã€‚`
                        : `å½“å‰ç¾è”å‚¨ç»´æŒåˆ©ç‡ä¸å˜ï¼Œåˆ©ç‡é¢„æœŸå·²å……åˆ†å®šä»·ã€‚${name}åŸºæœ¬é¢ä¸å—åˆ©ç‡ç›´æ¥å½±å“ã€‚ç¾è”å‚¨æ”¿ç­–å½“å‰ä¸æ˜¯ä¸»è¦çŸ›ç›¾ï¼Œå…³æ³¨å…¬å¸è‡ªèº«ä¸šç»©æ›´é‡è¦ã€‚`
                }),
                'å—å‘èµ„é‡‘': () => ({
                    isSignal: status.includes('æµå…¥'),
                    conclusion: status.includes('æµå…¥') ? 'èµ„é‡‘æµå…¥ï¼Œä¸­æœŸåˆ©å¥½' : 'èµ„é‡‘æµå‡ºï¼Œä½†å±æ­£å¸¸',
                    reasoning: status.includes('æµå…¥')
                        ? `å—å‘èµ„é‡‘æŒç»­æµå…¥${name}ï¼Œåæ˜ å†…åœ°æŠ•èµ„è€…å¯¹æ¸¯è‚¡çš„é…ç½®æ„æ„¿ã€‚<b>é€»è¾‘æ¨å¯¼ï¼š</b>å—å‘èµ„é‡‘å¢æŒ â†’ æµåŠ¨æ€§æ”¹å–„ â†’ ä¼°å€¼ä¿®å¤ â†’ è‚¡ä»·æ”¯æ’‘`
                        : `å—å‘èµ„é‡‘çŸ­æœŸæµå‡º${name}ï¼Œä½†æµå‡ºè§„æ¨¡å æ—¥æˆäº¤é¢æ¯”ä¾‹ä½ï¼Œå±äºæ­£å¸¸è·åˆ©äº†ç»“ã€‚çŸ­æœŸèµ„é‡‘æµåŠ¨ä¸å½±å“å…¬å¸ä»·å€¼ï¼Œè‹¥åŸºæœ¬é¢æœªå˜ï¼Œæµå‡ºåè€Œæ˜¯åŠ ä»“æœºä¼šã€‚`
                }),
                'è¡Œä¸šæ”¿ç­–': () => ({
                    isSignal: status.includes('æœ‰å˜åŒ–'),
                    conclusion: status.includes('æœ‰å˜åŒ–') ? 'æ”¿ç­–æœ‰å˜ï¼Œéœ€è¯„ä¼°å½±å“' : 'æ”¿ç­–ç¨³å®šï¼Œç¯å¢ƒè‰¯å¥½',
                    reasoning: status.includes('æœ‰å˜åŒ–')
                        ? `è¡Œä¸šæ”¿ç­–å˜åŒ–å¯¹${name}çš„å½±å“è¯„ä¼°ï¼šæ ¸å¿ƒä¸šåŠ¡ä¸æ”¿ç­–é«˜åº¦ç›¸å…³ã€‚å»ºè®®çŸ­æœŸå›é¿æ”¿ç­–ä¸ç¡®å®šæ€§ï¼Œä¸­é•¿æœŸå…³æ³¨å…¬å¸åº”å¯¹èƒ½åŠ›ã€‚`
                        : `å½“å‰è¡Œä¸šæ”¿ç­–ç¯å¢ƒç¨³å®šï¼Œç›‘ç®¡æ”¿ç­–æ— å®è´¨æ€§å˜åŒ–ã€‚æ”¿ç­–ä¸æ˜¯å½“å‰ä¸»è¦çŸ›ç›¾ï¼Œå…³æ³¨å…¬å¸ä¸šç»©å¢é•¿å’Œç«äº‰åŠ›æå‡ã€‚`
                }),
                'èµ„é‡‘æµå‘': () => ({
                    isSignal: status.includes('æµå…¥') || status.includes('æµå‡º'),
                    conclusion: status.includes('æµå…¥') ? 'æœºæ„æµå…¥ï¼Œæ€åº¦ç§¯æ' : status.includes('æµå‡º') ? 'æœºæ„æµå‡ºï¼Œéœ€è­¦æƒ•' : 'èµ„é‡‘å¹³è¡¡ï¼Œæ­£å¸¸æ³¢åŠ¨',
                    reasoning: status.includes('æµå…¥')
                        ? `ä¸»åŠ›èµ„é‡‘æŒç»­æµå…¥${name}ï¼Œåæ˜ æœºæ„æ€åº¦ç§¯æã€‚<b>é€»è¾‘æ¨å¯¼ï¼š</b>æœºæ„èµ„é‡‘æµå…¥ â†’ ç ”ç©¶è¦†ç›–å¢åŠ  â†’ å¸‚åœºå…³æ³¨åº¦æå‡ â†’ ä¼°å€¼ä¿®å¤`
                        : status.includes('æµå‡º')
                        ? `ä¸»åŠ›èµ„é‡‘æµå‡º${name}ï¼Œéœ€è­¦æƒ•ã€‚å¯èƒ½åŸå› ï¼šä¸šç»©é¢„æœŸä¸‹è°ƒã€è¡Œä¸šé…ç½®è°ƒæ•´ã€‚å»ºè®®æ ¸æŸ¥åŸºæœ¬é¢æ˜¯å¦æ¶åŒ–ï¼Œè‹¥æ— å®è´¨å˜åŒ–ï¼Œæµå‡ºå¯èƒ½æ˜¯æƒ…ç»ªè¿‡åº¦ååº”ã€‚`
                        : `ä¸»åŠ›èµ„é‡‘æµåŠ¨å¹³è¡¡ï¼Œå•æ—¥èµ„é‡‘æµåŠ¨å±äºæ­£å¸¸äº¤æ˜“è¡Œä¸ºã€‚çŸ­æœŸèµ„é‡‘æµåŠ¨ä¸æ”¹å˜å…¬å¸ä»·å€¼ï¼Œå…³æ³¨å­£åº¦æœºæ„æŒä»“å˜åŒ–æ›´æœ‰æ„ä¹‰ã€‚`
                }),
                'æŠ€æœ¯æŒ‡æ ‡': () => ({
                    isSignal: status.includes('çªç ´'),
                    conclusion: status.includes('çªç ´') ? 'æŠ€æœ¯çªç ´ï¼Œè¶‹åŠ¿è½¬å¼º' : 'æŠ€æœ¯æ­£å¸¸ï¼Œæ— æ˜ç¡®ä¿¡å·',
                    reasoning: status.includes('çªç ´')
                        ? `${name}æŠ€æœ¯é¢å‡ºç°çªç ´ä¿¡å·ï¼šè‚¡ä»·çªç ´20æ—¥å‡çº¿ï¼Œæˆäº¤é‡æ”¾å¤§ã€‚æŠ€æœ¯é¢çªç ´å¯è§†ä¸ºçŸ­æœŸå…¥åœºä¿¡å·ï¼Œä½†éœ€ç»“åˆåŸºæœ¬é¢åˆ¤æ–­æ˜¯å¦å¯æŒç»­ã€‚`
                        : `${name}æŠ€æœ¯æŒ‡æ ‡æ­£å¸¸ï¼Œè‚¡ä»·åœ¨å‡çº¿é™„è¿‘éœ‡è¡ï¼Œæ— æ˜ç¡®è¶‹åŠ¿ã€‚æŠ€æœ¯é¢æœªç»™å‡ºæ˜ç¡®æ–¹å‘ï¼Œæ­¤æ—¶æ›´åº”å…³æ³¨åŸºæœ¬é¢å˜åŒ–ã€‚`
                })
            };
            
            return insights[itemName] ? insights[itemName]() : {
                isSignal: false,
                conclusion: 'å½±å“ä¸­ç­‰ï¼ŒæŒç»­å…³æ³¨',
                reasoning: `${itemName}å½“å‰çŠ¶æ€ï¼š${status}ã€‚ç»åˆ†æï¼Œè¯¥å› ç´ å¯¹${name}çš„è‚¡ä»·å½±å“ç¨‹åº¦ä¸ºä¸­ç­‰ï¼Œå»ºè®®æŒç»­å…³æ³¨ã€‚`
            };
        }

        // ç”Ÿæˆç»¼åˆæŠ•èµ„å»ºè®®
        function generateRecommendation(stock, items) {
            const seed = stock.symbol.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            
            // è®¡ç®—ä¿¡å·å¼ºåº¦
            let signalScore = 0;
            let signalCount = 0;
            let noiseCount = 0;
            
            items.forEach(item => {
                if (item.status.includes('å³å°†') || item.status.includes('éœ€å…³æ³¨') || item.status.includes('æµå…¥') || item.status.includes('çªç ´') || item.status.includes('æœ‰å˜åŒ–')) {
                    signalScore += 1;
                    signalCount++;
                } else if (item.status.includes('æ— å¼‚å¸¸') || item.status.includes('ç¨³å®š') || item.status.includes('æ­£å¸¸')) {
                    signalScore -= 0.5;
                    noiseCount++;
                }
            });
            
            // æ ¹æ®å¾—åˆ†ç¡®å®šå»ºè®®
            const confidence = Math.min(85, 50 + Math.abs(signalScore) * 15 + (seed % 10));
            
            if (signalScore >= 2) {
                return {
                    action: 'å»ºè®®ä¹°å…¥',
                    icon: 'ğŸŸ¢',
                    color: '#52C41A',
                    bgColor: '#F6FFED',
                    borderColor: '#52C41A',
                    confidence,
                    reasoning: `ç»¼åˆ${signalCount}ä¸ªç§¯æä¿¡å·ï¼š${items.filter(i => i.status.includes('å³å°†') || i.status.includes('æµå…¥')).map(i => i.name).join('ã€')}ã€‚å½“å‰æ˜¯è¾ƒå¥½çš„å…¥åœºæ—¶æœºï¼Œå»ºè®®åˆ†æ‰¹å»ºä»“ã€‚`
                };
            } else if (signalScore <= -1) {
                return {
                    action: 'å»ºè®®å‡ä»“',
                    icon: 'ğŸ”´',
                    color: '#FF4D4F',
                    bgColor: '#FFF1F0',
                    borderColor: '#FF4D4F',
                    confidence,
                    reasoning: `æ£€æµ‹åˆ°${noiseCount}ä¸ªé£é™©å› ç´ ï¼ŒçŸ­æœŸç¼ºä¹ä¸Šæ¶¨å‚¬åŒ–å‰‚ã€‚å»ºè®®é€‚å½“å‡ä»“ï¼Œç­‰å¾…æ›´å¥½çš„å…¥åœºæ—¶æœºã€‚`
                };
            } else {
                return {
                    action: 'å»ºè®®æŒæœ‰',
                    icon: 'âšª',
                    color: '#FAAD14',
                    bgColor: '#FFFBE6',
                    borderColor: '#FAAD14',
                    confidence,
                    reasoning: `å¤šç©ºå› ç´ äº¤ç»‡ï¼Œä¿¡å·ä¸æ˜ç¡®ã€‚å½“å‰æŒä»“å¯ç»§ç»­æŒæœ‰ï¼Œä½†æš‚ä¸å»ºè®®æ–°å¼€ä»“ä½ã€‚å»ºè®®å…³æ³¨åç»­ä¸šç»©å’Œæ”¿ç­–å˜åŒ–ã€‚`
                };
            }
        }

        // æ™ºæŠ•é•œå¤´ï¼šæ¯ä¸ªé•œå¤´ç‹¬ç«‹åˆ†æï¼Œå¯èƒ½å¾—å‡ºä¸åŒç»“è®º
        function generateLensViews(stock, items) {
            const seed = stock.symbol.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            
            // ä¸ºæ¯ä¸ªé•œå¤´å‡†å¤‡åˆ†ææ•°æ®
            const earnings = items.find(i => i.name === 'ä¸šç»©é¢„æœŸ');
            const news = items.find(i => i.name === 'æ–°é—»èˆ†æƒ…');
            const fundFlow = items.find(i => i.name === 'èµ„é‡‘æµå‘');
            const tech = items.find(i => i.name === 'æŠ€æœ¯æŒ‡æ ‡');
            const policy = items.find(i => i.name === 'è¡Œä¸šæ”¿ç­–') || items.find(i => i.name === 'ç¾è”å‚¨æ”¿ç­–') || items.find(i => i.name === 'å—å‘èµ„é‡‘');
            
            const lenses = [
                {
                    name: 'ä»·å€¼æŠ•èµ„è€…',
                    icon: 'ğŸ“š',
                    color: '#1890FF',
                    bgColor: '#E6F7FF',
                    analyze: () => {
                        // ä»·å€¼æŠ•èµ„è€…å…³æ³¨ï¼šä¸šç»©ã€æ”¿ç­–ç¨³å®šæ€§
                        const hasEarningsSignal = earnings && (earnings.status.includes('å³å°†') || earnings.history?.filter(h => h.beat).length >= 3);
                        const policyStable = policy && !policy.status.includes('æœ‰å˜åŒ–');
                        
                        if (hasEarningsSignal && policyStable) {
                            return {
                                action: 'å»ºè®®ä¹°å…¥',
                                icon: 'ğŸŸ¢',
                                reasoning: `${stock.name}ä¸šç»©ç¨³å®šä¸”æ”¿ç­–ç¯å¢ƒè‰¯å¥½ã€‚ä»·å€¼æŠ•èµ„è€…çœ‹é‡çš„æ˜¯å…¬å¸æŠ¤åŸæ²³å’Œç›ˆåˆ©èƒ½åŠ›ï¼Œå½“å‰ä¼°å€¼å…·å¤‡å®‰å…¨è¾¹é™…ã€‚`,
                                confidence: 75
                            };
                        } else if (!policyStable) {
                            return {
                                action: 'å»ºè®®è§‚æœ›',
                                icon: 'âšª',
                                reasoning: `æ”¿ç­–ç¯å¢ƒå­˜åœ¨ä¸ç¡®å®šæ€§ï¼Œä»·å€¼æŠ•èµ„è€…åº”ç­‰å¾…æ”¿ç­–æ˜æœ—åå†åšå†³ç­–ã€‚çŸ­æœŸæ³¢åŠ¨ä¸å½±å“é•¿æœŸä»·å€¼åˆ¤æ–­ã€‚`,
                                confidence: 60
                            };
                        }
                        return {
                            action: 'å»ºè®®æŒæœ‰',
                            icon: 'âšª',
                            reasoning: `${stock.name}åŸºæœ¬é¢ç¨³å¥ï¼Œå½“å‰ä¼°å€¼åˆç†ã€‚ä»·å€¼æŠ•èµ„è€…æ— éœ€é¢‘ç¹äº¤æ˜“ï¼Œç»§ç»­æŒæœ‰å³å¯ã€‚`,
                            confidence: 65
                        };
                    }
                },
                {
                    name: 'è¶‹åŠ¿è·Ÿè¸ªè€…',
                    icon: 'ğŸ“ˆ',
                    color: '#52C41A',
                    bgColor: '#F6FFED',
                    analyze: () => {
                        // è¶‹åŠ¿è·Ÿè¸ªè€…å…³æ³¨ï¼šèµ„é‡‘æµå‘ã€æŠ€æœ¯çªç ´
                        const hasFlow = fundFlow && fundFlow.status.includes('æµå…¥');
                        const hasBreakout = tech && tech.status.includes('çªç ´');
                        
                        if (hasFlow && hasBreakout) {
                            return {
                                action: 'å¼ºçƒˆä¹°å…¥',
                                icon: 'ğŸŸ¢',
                                reasoning: `èµ„é‡‘æµå…¥+æŠ€æœ¯çªç ´ï¼ŒåŒé‡è¶‹åŠ¿ç¡®è®¤ã€‚${stock.name}å¯èƒ½è¿›å…¥ä¸»å‡æµªï¼Œè¶‹åŠ¿æŠ•èµ„è€…åº”æœæ–­è·Ÿè¿›ã€‚`,
                                confidence: 85
                            };
                        } else if (hasFlow || hasBreakout) {
                            return {
                                action: 'å»ºè®®ä¹°å…¥',
                                icon: 'ğŸŸ¢',
                                reasoning: `å‡ºç°è¶‹åŠ¿ä¿¡å·ï¼ˆ${hasFlow ? 'èµ„é‡‘æµå…¥' : 'æŠ€æœ¯çªç ´'}ï¼‰ï¼Œå»ºè®®è·Ÿéšè¶‹åŠ¿å»ºä»“ã€‚`,
                                confidence: 70
                            };
                        } else if (fundFlow && fundFlow.status.includes('æµå‡º')) {
                            return {
                                action: 'å»ºè®®å‡ä»“',
                                icon: 'ğŸ”´',
                                reasoning: `èµ„é‡‘æµå‡ºæ˜¾ç¤ºè¶‹åŠ¿è½¬å¼±ï¼Œè¶‹åŠ¿æŠ•èµ„è€…åº”æœæ–­å‡ä»“ï¼Œé¿å…é€†åŠ¿æ“ä½œã€‚`,
                                confidence: 70
                            };
                        }
                        return {
                            action: 'è§‚æœ›ç­‰å¾…',
                            icon: 'âšª',
                            reasoning: `æ— æ˜æ˜¾è¶‹åŠ¿ä¿¡å·ï¼Œè¶‹åŠ¿æŠ•èµ„è€…åº”è€å¿ƒç­‰å¾…æ˜ç¡®æ–¹å‘å‡ºç°ã€‚`,
                            confidence: 50
                        };
                    }
                },
                {
                    name: 'é‡åŒ–äº¤æ˜“è€…',
                    icon: 'ğŸ¤–',
                    color: '#722ED1',
                    bgColor: '#F9F0FF',
                    analyze: () => {
                        // é‡åŒ–äº¤æ˜“è€…ï¼šåŸºäºç»Ÿè®¡æ¦‚ç‡
                        const signalCount = items.filter(i => 
                            i.status.includes('å³å°†') || i.status.includes('æµå…¥') || 
                            i.status.includes('çªç ´') || i.status.includes('éœ€å…³æ³¨')
                        ).length;
                        
                        const winRate = 45 + signalCount * 8 + (seed % 10);
                        const expectedReturn = (signalCount * 2 - 3 + (seed % 5)).toFixed(1);
                        
                        if (winRate > 65) {
                            return {
                                action: 'å»ºè®®ä¹°å…¥',
                                icon: 'ğŸŸ¢',
                                reasoning: `é‡åŒ–æ¨¡å‹èƒœç‡${winRate}%ï¼ŒæœŸæœ›æ”¶ç›Š+${expectedReturn}%ã€‚ç»Ÿè®¡ä¼˜åŠ¿æ˜ç¡®ï¼Œå»ºè®®æ‰§è¡Œäº¤æ˜“ã€‚`,
                                confidence: winRate
                            };
                        } else if (winRate < 45) {
                            return {
                                action: 'å»ºè®®å‡ä»“',
                                icon: 'ğŸ”´',
                                reasoning: `é‡åŒ–æ¨¡å‹èƒœç‡ä»…${winRate}%ï¼ŒæœŸæœ›æ”¶ç›Š${expectedReturn}%ã€‚æ¦‚ç‡ä¸å ä¼˜ï¼Œå»ºè®®é™ä½ä»“ä½ã€‚`,
                                confidence: 100 - winRate
                            };
                        }
                        return {
                            action: 'ç»´æŒä»“ä½',
                            icon: 'âšª',
                            reasoning: `é‡åŒ–æ¨¡å‹èƒœç‡${winRate}%ï¼Œå¤„äºä¸­æ€§åŒºé—´ã€‚æ— ç»Ÿè®¡ä¼˜åŠ¿ï¼Œç»´æŒå½“å‰ä»“ä½ã€‚`,
                            confidence: 55
                        };
                    }
                },
                {
                    name: 'å®è§‚å¯¹å†²è€…',
                    icon: 'ğŸŒ',
                    color: '#FA8C16',
                    bgColor: '#FFF7E6',
                    analyze: () => {
                        // å®è§‚å¯¹å†²è€…å…³æ³¨ï¼šç¾è”å‚¨/å—å‘èµ„é‡‘ã€è¡Œä¸šæ”¿ç­–
                        const macroPositive = policy && (policy.status.includes('æµå…¥') || !policy.status.includes('æœ‰å˜åŒ–'));
                        const industryStable = items.find(i => i.name === 'è¡Œä¸šæ”¿ç­–')?.status.includes('ç¨³å®š');
                        
                        if (macroPositive && industryStable) {
                            return {
                                action: 'å»ºè®®å¢é…',
                                icon: 'ğŸŸ¢',
                                reasoning: `å®è§‚ç¯å¢ƒå‹å¥½ï¼Œ${stock.market === 'HK' ? 'å—å‘èµ„é‡‘æµå…¥' : 'æ”¿ç­–ç¨³å®š'}ã€‚å»ºè®®å¢é…${stock.name}ä½œä¸ºç»„åˆçš„ä¸€éƒ¨åˆ†ã€‚`,
                                confidence: 72
                            };
                        } else if (!macroPositive) {
                            return {
                                action: 'å»ºè®®å‡é…',
                                icon: 'ğŸ”´',
                                reasoning: `å®è§‚ç¯å¢ƒå­˜åœ¨å‹åŠ›ï¼Œå»ºè®®é™ä½${stock.name}çš„é…ç½®æ¯”ä¾‹ï¼Œè§„é¿ç³»ç»Ÿæ€§é£é™©ã€‚`,
                                confidence: 68
                            };
                        }
                        return {
                            action: 'ç»´æŒé…ç½®',
                            icon: 'âšª',
                            reasoning: `å®è§‚ç¯å¢ƒä¸­æ€§ï¼Œ${stock.name}å¯ä½œä¸ºç»„åˆçš„ç¨³å®šå™¨ï¼Œç»´æŒå½“å‰é…ç½®æ¯”ä¾‹ã€‚`,
                            confidence: 60
                        };
                    }
                },
                {
                    name: 'äº‹ä»¶é©±åŠ¨è€…',
                    icon: 'âš¡',
                    color: '#EB2F96',
                    bgColor: '#FFF0F6',
                    analyze: () => {
                        // äº‹ä»¶é©±åŠ¨è€…å…³æ³¨ï¼šè´¢æŠ¥ã€æ–°é—»
                        const hasEarnings = earnings && earnings.status.includes('å³å°†');
                        const hasNews = news && news.status.includes('éœ€å…³æ³¨');
                        
                        if (hasEarnings && hasNews) {
                            return {
                                action: 'æå‰å¸ƒå±€',
                                icon: 'ğŸŸ¢',
                                reasoning: `è´¢æŠ¥+æ–°é—»åŒé‡å‚¬åŒ–å‰‚ï¼Œäº‹ä»¶é©±åŠ¨è€…å¯åœ¨äº‹ä»¶æ˜æœ—å‰æå‰å¸ƒå±€ï¼Œåšå–äº‹ä»¶æ”¶ç›Šã€‚`,
                                confidence: 78
                            };
                        } else if (hasEarnings) {
                            return {
                                action: 'äº‹ä»¶å‰ä¹°å…¥',
                                icon: 'ğŸŸ¢',
                                reasoning: `è´¢æŠ¥äº‹ä»¶ä¸´è¿‘ï¼Œå†å²æ•°æ®æ˜¾ç¤º${stock.name}è´¢æŠ¥åæ³¢åŠ¨Â±${8 + (seed % 6)}%ï¼Œå¯æå‰å¸ƒå±€ã€‚`,
                                confidence: 70
                            };
                        } else if (hasNews) {
                            return {
                                action: 'è°¨æ…å‚ä¸',
                                icon: 'âšª',
                                reasoning: `æ–°é—»äº‹ä»¶å­˜åœ¨ä¸ç¡®å®šæ€§ï¼Œäº‹ä»¶é©±åŠ¨è€…å¯å°ä»“ä½å‚ä¸ï¼Œä¸¥æ ¼æ­¢æŸã€‚`,
                                confidence: 55
                            };
                        }
                        return {
                            action: 'ç­‰å¾…å‚¬åŒ–',
                            icon: 'âšª',
                            reasoning: `æš‚æ— æ˜ç¡®äº‹ä»¶å‚¬åŒ–ï¼Œäº‹ä»¶é©±åŠ¨è€…åº”è€å¿ƒç­‰å¾…ä¸‹ä¸€ä¸ªæœºä¼šã€‚`,
                            confidence: 50
                        };
                    }
                },
                {
                    name: 'é•¿æœŸæŒæœ‰è€…',
                    icon: 'ğŸ’',
                    color: '#13C2C2',
                    bgColor: '#E6FFFB',
                    analyze: () => {
                        // é•¿æœŸæŒæœ‰è€…ï¼šå‡ ä¹æ°¸è¿œæŒæœ‰ï¼Œé™¤éåŸºæœ¬é¢æ¶åŒ–
                        const fundamentalsOk = !items.some(i => 
                            i.name === 'è¡Œä¸šæ”¿ç­–' && i.status.includes('æœ‰å˜åŒ–')
                        );
                        
                        if (fundamentalsOk) {
                            return {
                                action: 'å®šæŠ•åŠ ä»“',
                                icon: 'ğŸŸ¢',
                                reasoning: `${stock.name}é•¿æœŸé€»è¾‘ç¨³å›ºï¼ŒçŸ­æœŸæ³¢åŠ¨æ˜¯å®šæŠ•çš„å¥½æœºä¼šã€‚é•¿æœŸæŒæœ‰è€…åº”ä¿æŒçºªå¾‹ï¼ŒæŒç»­å®šæŠ•ã€‚`,
                                confidence: 80
                            };
                        }
                        return {
                            action: 'æš‚åœå®šæŠ•',
                            icon: 'âšª',
                            reasoning: `åŸºæœ¬é¢å­˜åœ¨ä¸ç¡®å®šæ€§ï¼Œé•¿æœŸæŒæœ‰è€…å¯æš‚åœå®šæŠ•ï¼Œç­‰å¾…å½¢åŠ¿æ˜æœ—åå†æ¢å¤ã€‚`,
                            confidence: 65
                        };
                    }
                }
            ];
            
            // æ‰§è¡Œæ¯ä¸ªé•œå¤´çš„åˆ†æ
            return lenses.map(lens => {
                const result = lens.analyze();
                return {
                    ...lens,
                    ...result,
                    isBuy: result.action.includes('ä¹°å…¥') || result.action.includes('å¸ƒå±€') || result.action.includes('åŠ ä»“'),
                    isSell: result.action.includes('å‡ä»“') || result.action.includes('å‡é…')
                };
            });
        }

        // æ˜¾ç¤ºé•œå¤´è¯¦æƒ…ï¼ˆåœ¨å½“å‰é¡µé¢æ˜¾ç¤ºï¼Œä¸å¼¹çª—ï¼‰
        async function showLensDetail(symbol, lensIdx) {
            const detailContainer = document.getElementById(`lens-detail-${symbol}`);
            const btn = document.querySelector(`button.lens-btn-${symbol}[data-lens-idx="${lensIdx}"]`);
            if (!btn || !detailContainer) return;
            
            // å¦‚æœå·²ç»æœ‰æ•°æ®ï¼Œç›´æ¥åˆ‡æ¢æ˜¾ç¤º/éšè—
            if (detailContainer.dataset.currentSymbol === symbol && detailContainer.dataset.currentLensIdx === String(lensIdx)) {
                if (detailContainer.style.display === 'block') {
                    detailContainer.style.display = 'none';
                    return;
                }
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            detailContainer.style.display = 'block';
            detailContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-tertiary);">ğŸ¤– AIåˆ†æä¸­...</div>';
            
            try {
                // è°ƒç”¨åç«¯APIè·å–çœŸå®åˆ†æ
                const response = await fetch(`${API_BASE_URL}/api/analysis/realtime/${symbol}?market=US`);
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    console.error('JSON parse error:', text.substring(0, 200));
                    throw new Error('è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                }
                
                if (!result.success || !result.analysis) {
                    throw new Error('è·å–åˆ†æå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
                
                const analysis = result.analysis;
                const lensData = JSON.parse(btn.dataset.lens);
                
                // æ‰¾åˆ°å¯¹åº”çš„é•œå¤´å»ºè®®
                const lensAdvice = analysis['è§†è§’å»ºè®®']?.find(l => l.name.includes(lensData.name)) || {
                    action: lensData.action,
                    confidence: lensData.confidence,
                    judgment: 'åŸºäºå½“å‰æ•°æ®åˆ†æ',
                    operationAdvice: lensData.reasoning
                };
                
                detailContainer.dataset.currentSymbol = symbol;
                detailContainer.dataset.currentLensIdx = lensIdx;
                
                // ç”Ÿæˆè¯¦ç»†æ“ä½œå»ºè®®
                const operationReason = generateOperationReason(lensAdvice);
                
                detailContainer.innerHTML = `
                    <div style="padding: 16px; background: ${lensData.bgColor}; border-radius: 12px; border: 2px solid ${lensData.color};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 18px;">${lensData.icon}</span>
                                <div style="font-size: 14px; font-weight: 600; color: ${lensData.color};">${lensData.name}è§†è§’</div>
                            </div>
                            <div style="font-size: 12px; color: var(--text-tertiary);">ä¿¡å¿ƒåº¦: ${lensAdvice.confidence}%</div>
                        </div>
                        
                        <!-- æ ¸å¿ƒå…³æ³¨ -->
                        <div style="margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.3); border-radius: 6px;">
                            <div style="font-size: 11px; font-weight: 600; color: var(--text-tertiary); margin-bottom: 4px;">ğŸ¯ æ ¸å¿ƒå…³æ³¨</div>
                            <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.5;">${lensAdvice.focus || 'è¯¥è§†è§’çš„æ ¸å¿ƒæŠ•èµ„é€»è¾‘'}</div>
                        </div>
                        
                        <!-- å½“å‰åˆ¤æ–­ -->
                        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid ${lensData.color};">
                            <div style="font-size: 11px; font-weight: 600; color: var(--text-tertiary); margin-bottom: 6px;">ğŸ“Š å½“å‰åˆ¤æ–­</div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">${lensAdvice.judgment || lensAdvice.reasoning}</div>
                        </div>
                        
                        <!-- æ“ä½œå»ºè®® -->
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">ğŸ’¡ æ“ä½œå»ºè®® Â· ${lensAdvice.action} (ä¿¡å¿ƒåº¦${lensAdvice.confidence}%)</div>
                            <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.8; padding: 12px; background: white; border-radius: 8px;">
                                ${lensAdvice.operationAdvice}
                            </div>
                        </div>
                        
                        <!-- è¯¥é•œå¤´çš„æŠ•èµ„é€»è¾‘ -->
                        <div style="padding: 12px; background: rgba(255,255,255,0.5); border-radius: 8px;">
                            <div style="font-size: 11px; font-weight: 600; color: var(--text-tertiary); margin-bottom: 6px;">ğŸ” ${lensData.name}å…³æ³¨ä»€ä¹ˆï¼Ÿ</div>
                            <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.6;">
                                ${getLensDescription(lensData.name)}
                            </div>
                        </div>
                        
                        <!-- å®æ—¶æ•°æ®è¯´æ˜ -->
                        <div style="margin-top: 12px; padding: 8px; background: #F0F0F0; border-radius: 6px; font-size: 10px; color: var(--text-tertiary);">
                            åŸºäºå®æ—¶æ•°æ®: ä»·æ ¼ $${result.data?.price || 'N/A'} | æ¶¨è·Œ ${result.data?.changePercent || 'N/A'}% | åˆ†ææ—¶é—´: ${new Date().toLocaleString()}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('è·å–åˆ†æå¤±è´¥:', error);
                detailContainer.innerHTML = `
                    <div style="padding: 16px; background: #FFF1F0; border-radius: 8px; color: #FF4D4F;">
                        <div style="font-size: 13px;">âš ï¸ è·å–AIåˆ†æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>
                        <div style="font-size: 11px; margin-top: 8px; color: var(--text-tertiary);">${error.message}</div>
                    </div>
                `;
            }
        }

        // ç”Ÿæˆæ“ä½œå»ºè®®çš„è¯¦ç»†åŸå› 
        function generateOperationReason(lensData) {
            const action = lensData.action;
            const name = lensData.name;
            
            if (action.includes('ä¹°å…¥') || action.includes('åŠ ä»“') || action.includes('å¸ƒå±€')) {
                return `
                    <b>1. ä¿¡å·è§¦å‘æ¡ä»¶ï¼š</b><br>
                    ${name}æ£€æµ‹åˆ°å½“å‰å­˜åœ¨æ˜ç¡®çš„æ­£å‘ä¿¡å·ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šä¼°å€¼å¤„äºåˆç†åŒºé—´ã€æŠ€æœ¯é¢å‡ºç°çªç ´ã€èµ„é‡‘æµå‘ç§¯æã€æˆ–å³å°†å‘ç”Ÿåˆ©å¥½äº‹ä»¶ã€‚<br><br>
                    <b>2. é£é™©æ”¶ç›Šæ¯”ï¼š</b><br>
                    å½“å‰ä»·æ ¼ä¸‹ï¼Œä¸Šæ¶¨ç©ºé—´å¤§äºä¸‹è·Œé£é™©ã€‚å³ä½¿åˆ¤æ–­å¤±è¯¯ï¼Œæ­¢æŸç©ºé—´å¯æ§ï¼›è‹¥åˆ¤æ–­æ­£ç¡®ï¼Œæ”¶ç›Šç©ºé—´å¯è§‚ã€‚<br><br>
                    <b>3. æ“ä½œå»ºè®®ï¼š</b><br>
                    â€¢ æ¿€è¿›å‹ï¼šå¯ç«‹å³å»ºä»“ï¼Œä»“ä½æ§åˆ¶åœ¨æ€»èµ„äº§çš„5-10%<br>
                    â€¢ ç¨³å¥å‹ï¼šåˆ†æ‰¹ä¹°å…¥ï¼Œé¦–æ¬¡å»ºä»“3%ï¼Œåç»­æ ¹æ®èµ°åŠ¿åŠ ä»“<br>
                    â€¢ ä¿å®ˆå‹ï¼šç­‰å¾…å›è°ƒæˆ–æ›´æ˜ç¡®ä¿¡å·åå†å…¥åœº
                `;
            } else if (action.includes('å–å‡º') || action.includes('å‡ä»“') || action.includes('å‡é…')) {
                return `
                    <b>1. é£é™©ä¿¡å·è¯†åˆ«ï¼š</b><br>
                    ${name}æ£€æµ‹åˆ°å½“å‰å­˜åœ¨é£é™©ä¿¡å·ï¼Œå¯èƒ½åŒ…æ‹¬ï¼šä¼°å€¼è¿‡é«˜ã€æŠ€æœ¯é¢èµ°å¼±ã€èµ„é‡‘æŒç»­æµå‡ºã€æˆ–åŸºæœ¬é¢å‡ºç°æ¶åŒ–è¿¹è±¡ã€‚<br><br>
                    <b>2. æ­¢ç›ˆ/æ­¢æŸè€ƒé‡ï¼š</b><br>
                    è‹¥å·²æœ‰ç›ˆåˆ©ï¼Œå»ºè®®é”å®šéƒ¨åˆ†åˆ©æ¶¦ï¼›è‹¥å¤„äºäºæŸï¼Œéœ€è¯„ä¼°æ˜¯å¦è§¦å‘æ­¢æŸçºªå¾‹ã€‚ä¸è¦è®©ç›ˆåˆ©å˜äºæŸï¼Œä¸è¦è®©å°äºå˜å¤§äºã€‚<br><br>
                    <b>3. æ“ä½œå»ºè®®ï¼š</b><br>
                    â€¢ æ­¢ç›ˆï¼šå¯å–å‡º30-50%ä»“ä½ï¼Œä¿ç•™éƒ¨åˆ†ç»§ç»­è§‚å¯Ÿ<br>
                    â€¢ æ­¢æŸï¼šæœæ–­æ‰§è¡Œï¼Œé¿å…æƒ…ç»ªåŒ–åŠ ä»“æ‘Šä½æˆæœ¬<br>
                    â€¢ è°ƒä»“ï¼šå°†èµ„é‡‘è½¬ç§»è‡³æ›´å…·æ€§ä»·æ¯”çš„æ ‡çš„
                `;
            } else {
                return `
                    <b>1. ä¿¡å·ä¸æ˜ç¡®ï¼š</b><br>
                    ${name}åˆ†ææ˜¾ç¤ºï¼Œå½“å‰å¤šç©ºå› ç´ äº¤ç»‡ï¼Œæ²¡æœ‰å½¢æˆæ˜ç¡®çš„è¶‹åŠ¿æ–¹å‘ã€‚æ—¢ä¸å­˜åœ¨å¼ºçƒˆçš„ä¹°å…¥ä¿¡å·ï¼Œä¹Ÿä¸å­˜åœ¨è¿«åˆ‡çš„å–å‡ºç†ç”±ã€‚<br><br>
                    <b>2. æ—¶é—´æˆæœ¬è€ƒé‡ï¼š</b><br>
                    åœ¨éœ‡è¡å¸‚ä¸­é¢‘ç¹äº¤æ˜“å®¹æ˜“äº§ç”ŸæŸè€—ã€‚æŒæœ‰ç°é‡‘æˆ–ä¿æŒç°æœ‰ä»“ä½ï¼Œç­‰å¾…æ›´æ˜ç¡®çš„ä¿¡å·å‡ºç°ï¼Œå¾€å¾€æ˜¯æ›´ä¼˜é€‰æ‹©ã€‚<br><br>
                    <b>3. æ“ä½œå»ºè®®ï¼š</b><br>
                    â€¢ å·²æœ‰æŒä»“ï¼šç»§ç»­æŒæœ‰ï¼Œè®¾ç½®å¥½æ­¢ç›ˆæ­¢æŸä½<br>
                    â€¢ ç©ºä»“è§‚æœ›ï¼šè€å¿ƒç­‰å¾…ï¼Œä¸è¦æ€¥äºå…¥åœº<br>
                    â€¢ æŒç»­è·Ÿè¸ªï¼šå…³æ³¨å…³é”®æŒ‡æ ‡å˜åŒ–ï¼Œéšæ—¶å‡†å¤‡è¡ŒåŠ¨
                `;
            }
        }

        // è·å–é•œå¤´æè¿°
        function getLensDescription(lensName) {
            const descriptions = {
                'ä»·å€¼æŠ•èµ„è€…': 'å…³æ³¨å…¬å¸å†…åœ¨ä»·å€¼ã€æŠ¤åŸæ²³ã€ç›ˆåˆ©èƒ½åŠ›å’Œä¼°å€¼å®‰å…¨è¾¹é™…ã€‚å¿½ç•¥çŸ­æœŸæ³¢åŠ¨ï¼Œçœ‹é‡é•¿æœŸç«äº‰åŠ›ã€‚ä¹°å…¥æ ‡å‡†æ˜¯ä»·æ ¼ä½äºå†…åœ¨ä»·å€¼ï¼Œå–å‡ºæ ‡å‡†æ˜¯ä»·æ ¼æ˜¾è‘—é«˜äºå†…åœ¨ä»·å€¼æˆ–åŸºæœ¬é¢æ¶åŒ–ã€‚',
                'è¶‹åŠ¿è·Ÿè¸ªè€…': 'å…³æ³¨ä»·æ ¼è¶‹åŠ¿ã€æˆäº¤é‡å˜åŒ–å’Œå¸‚åœºåŠ¨é‡ã€‚é¡ºåŠ¿è€Œä¸ºï¼Œä¸é¢„æµ‹åªè·Ÿéšã€‚ä¹°å…¥æ ‡å‡†æ˜¯è¶‹åŠ¿ç¡®ç«‹å‘ä¸Šï¼Œå–å‡ºæ ‡å‡†æ˜¯è¶‹åŠ¿åè½¬æˆ–è·Œç ´å…³é”®æ”¯æ’‘ä½ã€‚',
                'é‡åŒ–äº¤æ˜“è€…': 'å…³æ³¨å†å²æ•°æ®ç»Ÿè®¡ã€æ¦‚ç‡ä¼˜åŠ¿å’ŒæœŸæœ›æ”¶ç›Šã€‚ç”¨æ•°å­¦æ¨¡å‹æŒ‡å¯¼äº¤æ˜“å†³ç­–ã€‚ä¹°å…¥æ ‡å‡†æ˜¯æ¨¡å‹ç»™å‡ºæ­£å‘ä¿¡å·ï¼Œå–å‡ºæ ‡å‡†æ˜¯ä¿¡å·æ¶ˆå¤±æˆ–è¾¾åˆ°æ­¢ç›ˆæ­¢æŸä½ã€‚',
                'å®è§‚å¯¹å†²è€…': 'å…³æ³¨å®è§‚ç»æµç¯å¢ƒã€æ”¿ç­–å˜åŒ–å’Œèµ„äº§é…ç½®ã€‚ä»å…¨å±€è§†è§’ä¼˜åŒ–ç»„åˆã€‚ä¹°å…¥æ ‡å‡†æ˜¯å®è§‚ç¯å¢ƒå‹å¥½ï¼Œå–å‡ºæ ‡å‡†æ˜¯ç³»ç»Ÿæ€§é£é™©ä¸Šå‡ã€‚',
                'äº‹ä»¶é©±åŠ¨è€…': 'å…³æ³¨ç‰¹å®šäº‹ä»¶ï¼ˆè´¢æŠ¥ã€å¹¶è´­ã€æ”¿ç­–ï¼‰å¸¦æ¥çš„æœºä¼šã€‚æå‰å¸ƒå±€æˆ–åŠæ—¶ååº”ã€‚ä¹°å…¥æ ‡å‡†æ˜¯äº‹ä»¶é¢„æœŸå‘å¥½ï¼Œå–å‡ºæ ‡å‡†æ˜¯äº‹ä»¶è½åœ°æˆ–é¢„æœŸè½ç©ºã€‚',
                'é•¿æœŸæŒæœ‰è€…': 'å…³æ³¨é•¿æœŸå¤åˆ©æ•ˆåº”ã€æ—¶é—´ä»·å€¼å’Œå®šæŠ•çºªå¾‹ã€‚å¿½ç•¥çŸ­æœŸæ³¢åŠ¨ï¼ŒåšæŒé•¿æœŸæŒæœ‰ã€‚ä¹°å…¥æ ‡å‡†æ˜¯ä¼˜è´¨èµ„äº§æ‰“æŠ˜ï¼Œå–å‡ºæ ‡å‡†æ˜¯é•¿æœŸé€»è¾‘ç ´åæˆ–éœ€è¦èµ„é‡‘ã€‚'
            };
            return descriptions[lensName] || 'è¯¥é•œå¤´åŸºäºç‰¹å®šæŠ•èµ„ç­–ç•¥å’Œåˆ†ææ¡†æ¶ï¼Œä¸ºæŠ•èµ„å†³ç­–æä¾›ç‹¬ç«‹è§†è§’ã€‚å»ºè®®ç»“åˆå¤šä¸ªé•œå¤´ç»¼åˆåˆ¤æ–­ã€‚';
        }

        // æ—§çš„å¼¹çª—å‡½æ•°ä¿ç•™ï¼ˆå…¼å®¹ï¼‰
        function showLensView(stockName, stockSymbol, lensData) {
            showLensDetail(stockSymbol, 0);
        }

        function showInsight(symbol, name, itemName, status, desc) {
            const insights = {
                'ä¸šç»©é¢„æœŸ': () => {
                    if (status.includes('å³å°†')) {
                        return `<b>ä¸ºä»€ä¹ˆæ˜¯ä¿¡å·ï¼Ÿ</b><br><br>${name}å³å°†å‘å¸ƒè´¢æŠ¥ï¼Œè¿™æ˜¯<b>é«˜ç¡®å®šæ€§äº‹ä»¶</b>ã€‚å†å²æ•°æ®æ˜¾ç¤ºï¼Œè¯¥å…¬å¸è´¢æŠ¥å3å¤©å†…è‚¡ä»·å¹³å‡æ³¢åŠ¨Â±8%ã€‚<br><br><b>å»ºè®®å…³æ³¨ï¼š</b><br>â€¢ è¥æ”¶å¢é€Ÿæ˜¯å¦è¶…é¢„æœŸ<br>â€¢ æ¯›åˆ©ç‡å˜åŒ–è¶‹åŠ¿<br>â€¢ ç®¡ç†å±‚å¯¹ä¸‹å­£åº¦æŒ‡å¼•`;
                    }
                    return `<b>ä¸ºä»€ä¹ˆæ˜¯å™ªéŸ³ï¼Ÿ</b><br><br>è·ç¦»${name}ä¸‹æ¬¡è´¢æŠ¥è¿˜æœ‰è¾ƒé•¿æ—¶é—´ï¼Œå½“å‰å¸‚åœºå®šä»·å·²å……åˆ†åæ˜ é¢„æœŸã€‚<br><br><b>å»ºè®®ï¼š</b>æ— éœ€è¿‡åº¦å…³æ³¨æ—¥åº¦æ³¢åŠ¨ï¼ŒæŠŠç²¾åŠ›æ”¾åœ¨è¡Œä¸šè¶‹åŠ¿å’Œå…¬å¸ç«äº‰åŠ›åˆ†æä¸Šã€‚`;
                },
                'æ–°é—»èˆ†æƒ…': () => {
                    if (status.includes('éœ€å…³æ³¨')) {
                        return `<b>ä¸ºä»€ä¹ˆæ˜¯ä¿¡å·ï¼Ÿ</b><br><br>æ£€æµ‹åˆ°ä¸${name}æ ¸å¿ƒä¸šåŠ¡ç›´æ¥ç›¸å…³çš„æ–°é—»ã€‚æ”¿ç­–å˜åŒ–å¯èƒ½å½±å“å…¬å¸æ”¶å…¥ã€‚<br><br><b>å»ºè®®ï¼š</b>æŒç»­è·Ÿè¸ªæ”¿ç­–ç»†èŠ‚ï¼Œè‹¥å‡ºç°å®è´¨æ€§å˜åŒ–ï¼Œéœ€é‡æ–°è¯„ä¼°æŒä»“ã€‚`;
                    }
                    return `<b>ä¸ºä»€ä¹ˆæ˜¯å™ªéŸ³ï¼Ÿ</b><br><br>24å°æ—¶å†…è™½æœ‰æ–°é—»ï¼Œä½†ä¸${name}æ ¸å¿ƒä¸šåŠ¡å…³è”åº¦ä½ï¼Œå¸‚åœºæƒ…ç»ªæŒ‡æ ‡å¤„äºæ­£å¸¸åŒºé—´ã€‚<br><br><b>ç»“è®ºï¼š</b>å±äºå¸‚åœºæ­£å¸¸ä¿¡æ¯æµåŠ¨ï¼Œæ— éœ€è¿‡åº¦ååº”ã€‚`;
                },
                'ç¾è”å‚¨æ”¿ç­–': () => {
                    if (status.includes('æœ‰å˜åŒ–')) {
                        return `<b>ä¸ºä»€ä¹ˆæ˜¯ä¿¡å·ï¼Ÿ</b><br><br>ç¾è”å‚¨æ”¿ç­–å˜åŒ–å¯¹${name}çš„å½±å“è·¯å¾„ï¼š<br>åˆ©ç‡å˜åŒ– â†’ æŠ˜ç°ç‡å˜åŒ– â†’ ä¼°å€¼é‡æ„<br><br><b>å»ºè®®ï¼š</b>å…³æ³¨FOMCä¼šè®®è¡¨æ€ï¼Œè‹¥é‡Šæ”¾æ˜ç¡®é™æ¯ä¿¡å·ï¼Œé«˜ä¼°å€¼ç§‘æŠ€è‚¡å¯èƒ½å—ç›Šã€‚`;
                    }
                    return `<b>ä¸ºä»€ä¹ˆæ˜¯å™ªéŸ³ï¼Ÿ</b><br><br>å½“å‰ç¾è”å‚¨ç»´æŒåˆ©ç‡ä¸å˜ï¼Œåˆ©ç‡é¢„æœŸå·²å……åˆ†å®šä»·ã€‚${name}åŸºæœ¬é¢ä¸å—åˆ©ç‡ç›´æ¥å½±å“ã€‚<br><br><b>ç»“è®ºï¼š</b>ç¾è”å‚¨æ”¿ç­–å½“å‰ä¸æ˜¯ä¸»è¦çŸ›ç›¾ï¼Œå…³æ³¨å…¬å¸è‡ªèº«ä¸šç»©æ›´é‡è¦ã€‚`;
                },
                'å—å‘èµ„é‡‘': () => {
                    if (status.includes('æµå…¥')) {
                        return `<b>ä¸ºä»€ä¹ˆæ˜¯ä¿¡å·ï¼Ÿ</b><br><br>å—å‘èµ„é‡‘æŒç»­æµå…¥${name}ï¼Œåæ˜ å†…åœ°æŠ•èµ„è€…å¯¹æ¸¯è‚¡çš„é…ç½®æ„æ„¿ã€‚<br><br><b>é€»è¾‘æ¨å¯¼ï¼š</b><br>å—å‘èµ„é‡‘å¢æŒ â†’ æµåŠ¨æ€§æ”¹å–„ â†’ ä¼°å€¼ä¿®å¤ â†’ è‚¡ä»·æ”¯æ’‘`;
                    }
                    return `<b>ä¸ºä»€ä¹ˆæ˜¯å™ªéŸ³ï¼Ÿ</b><br><br>å—å‘èµ„é‡‘çŸ­æœŸæµå‡º${name}ï¼Œä½†æµå‡ºè§„æ¨¡å æ—¥æˆäº¤é¢æ¯”ä¾‹ä½ï¼Œå±äºæ­£å¸¸è·åˆ©äº†ç»“ã€‚<br><br><b>ç»“è®ºï¼š</b>çŸ­æœŸèµ„é‡‘æµåŠ¨ä¸å½±å“å…¬å¸ä»·å€¼ï¼Œè‹¥åŸºæœ¬é¢æœªå˜ï¼Œæµå‡ºåè€Œæ˜¯åŠ ä»“æœºä¼šã€‚`;
                },
                'è¡Œä¸šæ”¿ç­–': () => {
                    if (status.includes('æœ‰å˜åŒ–')) {
                        return `<b>ä¸ºä»€ä¹ˆæ˜¯ä¿¡å·ï¼Ÿ</b><br><br>è¡Œä¸šæ”¿ç­–å˜åŒ–å¯¹${name}çš„å½±å“è¯„ä¼°ï¼šæ ¸å¿ƒä¸šåŠ¡ä¸æ”¿ç­–é«˜åº¦ç›¸å…³ã€‚<br><br><b>å»ºè®®ï¼š</b>çŸ­æœŸå›é¿æ”¿ç­–ä¸ç¡®å®šæ€§ï¼Œä¸­é•¿æœŸå…³æ³¨å…¬å¸åº”å¯¹èƒ½åŠ›ã€‚`;
                    }
                    return `<b>ä¸ºä»€ä¹ˆæ˜¯å™ªéŸ³ï¼Ÿ</b><br><br>å½“å‰è¡Œä¸šæ”¿ç­–ç¯å¢ƒç¨³å®šï¼Œç›‘ç®¡æ”¿ç­–æ— å®è´¨æ€§å˜åŒ–ã€‚<br><br><b>ç»“è®ºï¼š</b>æ”¿ç­–ä¸æ˜¯å½“å‰ä¸»è¦çŸ›ç›¾ï¼Œå…³æ³¨å…¬å¸ä¸šç»©å¢é•¿å’Œç«äº‰åŠ›æå‡ã€‚`;
                },
                'èµ„é‡‘æµå‘': () => {
                    if (status.includes('æµå…¥')) {
                        return `<b>ä¸ºä»€ä¹ˆæ˜¯ä¿¡å·ï¼Ÿ</b><br><br>ä¸»åŠ›èµ„é‡‘æŒç»­æµå…¥${name}ï¼Œåæ˜ æœºæ„æ€åº¦ç§¯æã€‚<br><br><b>é€»è¾‘æ¨å¯¼ï¼š</b><br>æœºæ„èµ„é‡‘æµå…¥ â†’ ç ”ç©¶è¦†ç›–å¢åŠ  â†’ å¸‚åœºå…³æ³¨åº¦æå‡ â†’ ä¼°å€¼ä¿®å¤`;
                    } else if (status.includes('æµå‡º')) {
                        return `<b>ä¸ºä»€ä¹ˆæ˜¯ä¿¡å·ï¼Ÿ</b><br><br>ä¸»åŠ›èµ„é‡‘æµå‡º${name}ï¼Œéœ€è­¦æƒ•ã€‚<br><br><b>å¯èƒ½åŸå› ï¼š</b><br>â€¢ ä¸šç»©é¢„æœŸä¸‹è°ƒ<br>â€¢ è¡Œä¸šé…ç½®è°ƒæ•´<br><br><b>å»ºè®®ï¼š</b>æ ¸æŸ¥åŸºæœ¬é¢æ˜¯å¦æ¶åŒ–ï¼Œè‹¥æ— å®è´¨å˜åŒ–ï¼Œæµå‡ºå¯èƒ½æ˜¯æƒ…ç»ªè¿‡åº¦ååº”ã€‚`;
                    }
                    return `<b>ä¸ºä»€ä¹ˆæ˜¯å™ªéŸ³ï¼Ÿ</b><br><br>ä¸»åŠ›èµ„é‡‘æµåŠ¨å¹³è¡¡ï¼Œå•æ—¥èµ„é‡‘æµåŠ¨å±äºæ­£å¸¸äº¤æ˜“è¡Œä¸ºã€‚<br><br><b>ç»“è®ºï¼š</b>çŸ­æœŸèµ„é‡‘æµåŠ¨ä¸æ”¹å˜å…¬å¸ä»·å€¼ï¼Œå…³æ³¨å­£åº¦æœºæ„æŒä»“å˜åŒ–æ›´æœ‰æ„ä¹‰ã€‚`;
                },
                'æŠ€æœ¯æŒ‡æ ‡': () => {
                    if (status.includes('çªç ´')) {
                        return `<b>ä¸ºä»€ä¹ˆæ˜¯ä¿¡å·ï¼Ÿ</b><br><br>${name}æŠ€æœ¯é¢å‡ºç°çªç ´ä¿¡å·ï¼š<br>â€¢ è‚¡ä»·çªç ´20æ—¥å‡çº¿<br>â€¢ æˆäº¤é‡æ”¾å¤§<br><br><b>å»ºè®®ï¼š</b>æŠ€æœ¯é¢çªç ´å¯è§†ä¸ºçŸ­æœŸå…¥åœºä¿¡å·ï¼Œä½†éœ€ç»“åˆåŸºæœ¬é¢åˆ¤æ–­æ˜¯å¦å¯æŒç»­ã€‚`;
                    }
                    return `<b>ä¸ºä»€ä¹ˆæ˜¯å™ªéŸ³ï¼Ÿ</b><br><br>${name}æŠ€æœ¯æŒ‡æ ‡æ­£å¸¸ï¼Œè‚¡ä»·åœ¨å‡çº¿é™„è¿‘éœ‡è¡ï¼Œæ— æ˜ç¡®è¶‹åŠ¿ã€‚<br><br><b>ç»“è®ºï¼š</b>æŠ€æœ¯é¢æœªç»™å‡ºæ˜ç¡®æ–¹å‘ï¼Œæ­¤æ—¶æ›´åº”å…³æ³¨åŸºæœ¬é¢å˜åŒ–ã€‚`;
                }
            };
            
            const content = insights[itemName] ? insights[itemName]() : `<b>${itemName}</b><br><br>å½“å‰çŠ¶æ€ï¼š${status}<br><br>ç»åˆ†æï¼Œè¯¥å› ç´ å¯¹${name}çš„è‚¡ä»·å½±å“ç¨‹åº¦ä¸ºä¸­ç­‰ï¼Œå»ºè®®æŒç»­å…³æ³¨ã€‚`;
            
            // åˆ›å»ºå¼¹çª—
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;max-width:480px;width:100%;max-height:80vh;overflow-y:auto;">
                    <div style="padding:20px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center;">
                        <div style="font-size:16px;font-weight:600;">ğŸ¤– AIæ·±åº¦è§£è¯»</div>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;">Ã—</button>
                    </div>
                    <div style="padding:20px;">
                        <div style="font-size:14px;color:var(--text-secondary);margin-bottom:12px;">${name} - ${itemName}</div>
                        <div style="font-size:13px;line-height:1.8;">${content}</div>
                    </div>
                    <div style="padding:16px 20px;border-top:1px solid var(--border-light);display:flex;gap:12px;">
                        <button onclick="this.closest('.modal-overlay').remove()" style="flex:1;padding:10px;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;">æ˜ç™½äº†</button>
                        <button onclick="copyInsight('${name}', '${itemName}', '${content.replace(/'/g, "\\'")}')" style="padding:10px 16px;background:#F0F0F0;border:none;border-radius:6px;cursor:pointer;">ğŸ“¤ å¤åˆ¶</button>
                    </div>
                </div>
            `;
            modal.className = 'modal-overlay';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }

        function copyInsight(name, itemName, content) {
            const text = `ã€${name}æŠ•èµ„ç¬”è®°ã€‘\n\n${itemName}ï¼š${content.replace(/<[^>]+>/g, '')}\n\nvia æŒä»“æ™ºæŠ•AI`;
            navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼')).catch(() => alert(text));
        }

        function showHistory(name, symbol, history) {
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const beatCount = history.filter(h => h.beat).length;
            const avgSurprise = (history.reduce((sum, h) => sum + (parseFloat(h.actual) - parseFloat(h.expected)), 0) / history.length).toFixed(2);
            
            // æ‰¾å‡ºæœ€å¤§/æœ€å°è¶…é¢„æœŸ
            const surprises = history.map(h => parseFloat(h.actual) - parseFloat(h.expected));
            const maxSurprise = Math.max(...surprises).toFixed(2);
            const minSurprise = Math.min(...surprises).toFixed(2);
            
            // ç”Ÿæˆå›¾è¡¨HTML
            const maxVal = Math.max(...history.map(h => Math.max(parseFloat(h.expected), parseFloat(h.actual)))) * 1.2;
            const chartRows = history.map(h => {
                const expectedPct = (parseFloat(h.expected) / maxVal * 100).toFixed(1);
                const actualPct = (parseFloat(h.actual) / maxVal * 100).toFixed(1);
                const diff = (parseFloat(h.actual) - parseFloat(h.expected)).toFixed(2);
                const diffColor = diff > 0 ? 'var(--rise)' : diff < 0 ? 'var(--fall)' : 'var(--text-secondary)';
                const diffSign = diff > 0 ? '+' : '';
                return `
                    <div style="margin-bottom:16px;">
                        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;">${h.period}</div>
                        <div style="display:flex;align-items:center;gap:8px;height:24px;">
                            <div style="width:60px;font-size:11px;color:var(--text-tertiary);">é¢„æœŸ</div>
                            <div style="flex:1;background:#F0F0F0;border-radius:4px;height:16px;position:relative;">
                                <div style="position:absolute;left:0;top:0;height:100%;background:#BFBFBF;border-radius:4px;width:${expectedPct}%;"></div>
                                <span style="position:absolute;left:${expectedPct}%;top:50%;transform:translate(-100%, -50%);font-size:10px;padding:0 4px;background:white;border-radius:2px;margin-left:-4px;">${h.expected}</span>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;height:24px;margin-top:4px;">
                            <div style="width:60px;font-size:11px;color:var(--text-tertiary);">å®é™…</div>
                            <div style="flex:1;background:#F0F0F0;border-radius:4px;height:16px;position:relative;">
                                <div style="position:absolute;left:0;top:0;height:100%;background:${h.beat ? 'var(--rise)' : 'var(--fall)'};border-radius:4px;width:${actualPct}%;"></div>
                                <span style="position:absolute;left:${actualPct}%;top:50%;transform:translate(-100%, -50%);font-size:10px;padding:0 4px;background:white;border-radius:2px;margin-left:-4px;font-weight:500;">${h.actual}</span>
                            </div>
                            <div style="width:50px;text-align:right;font-size:11px;color:${diffColor};font-weight:500;">${diffSign}${diff}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;max-width:520px;width:100%;max-height:85vh;overflow-y:auto;">
                    <div style="padding:20px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center;">
                        <div style="font-size:16px;font-weight:600;">ğŸ“Š ä¸šç»©å†å²å¯¹æ¯”</div>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;">Ã—</button>
                    </div>
                    <div style="padding:20px;">
                        <div style="font-size:14px;color:var(--text-secondary);margin-bottom:16px;">${name} (${symbol}) - è¿‡å»4ä¸ªå­£åº¦</div>
                        
                        <!-- ç»Ÿè®¡å¡ç‰‡ -->
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
                            <div style="background:var(--primary-light);padding:12px;border-radius:8px;text-align:center;">
                                <div style="font-size:20px;font-weight:600;color:var(--primary);">${beatCount}/4</div>
                                <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">è¶…é¢„æœŸæ¬¡æ•°</div>
                            </div>
                            <div style="background:${avgSurprise >= 0 ? 'var(--fall-bg)' : 'var(--rise-bg)'};padding:12px;border-radius:8px;text-align:center;">
                                <div style="font-size:20px;font-weight:600;color:${avgSurprise >= 0 ? 'var(--fall)' : 'var(--rise)'}">${avgSurprise > 0 ? '+' : ''}${avgSurprise}</div>
                                <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">å¹³å‡è¶…é¢„æœŸ</div>
                            </div>
                            <div style="background:#FFFBE6;padding:12px;border-radius:8px;text-align:center;">
                                <div style="font-size:20px;font-weight:600;color:var(--warning);">${maxSurprise > 0 ? '+' : ''}${maxSurprise}</div>
                                <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">æœ€å¤§æƒŠå–œ</div>
                            </div>
                        </div>
                        
                        <!-- å›¾è¡¨ -->
                        <div style="background:#FAFAFA;padding:16px;border-radius:8px;">
                            ${chartRows}
                        </div>
                        
                        <!-- å­¦ä¹ æç¤º -->
                        <div style="margin-top:16px;padding:12px;background:var(--primary-light);border-radius:8px;font-size:12px;line-height:1.6;">
                            <b>ğŸ’¡ å‘ç°è§„å¾‹ï¼š</b><br>
                            ${beatCount >= 3 ? 'è¯¥å…¬å¸ä¸šç»©ç¨³å®šæ€§è¾ƒå¼ºï¼Œè¶…é¢„æœŸæ¦‚ç‡é«˜ã€‚' : beatCount <= 1 ? 'è¯¥å…¬å¸ä¸šç»©æ³¢åŠ¨è¾ƒå¤§ï¼Œéœ€è­¦æƒ•ä¸åŠé¢„æœŸé£é™©ã€‚' : 'è¯¥å…¬å¸ä¸šç»©è¡¨ç°ä¸­è§„ä¸­çŸ©ï¼Œç¬¦åˆé¢„æœŸæ˜¯å¸¸æ€ã€‚'}<br>
                            ${parseFloat(avgSurprise) > 0.5 ? 'å†å²å¹³å‡è¶…é¢„æœŸå¹…åº¦è¾ƒå¤§ï¼Œå¸‚åœºå¯èƒ½ä½ä¼°å…¶ç›ˆåˆ©èƒ½åŠ›ã€‚' : parseFloat(avgSurprise) < -0.3 ? 'å†å²å¹³å‡ä½äºé¢„æœŸï¼Œéœ€å…³æ³¨åŸºæœ¬é¢æ˜¯å¦æ¶åŒ–ã€‚' : 'ä¸šç»©åŸºæœ¬ç¬¦åˆé¢„æœŸï¼Œä¼°å€¼ç›¸å¯¹åˆç†ã€‚'}
                        </div>
                    </div>
                    <div style="padding:16px 20px;border-top:1px solid var(--border-light);">
                        <button onclick="this.closest('.modal-overlay').remove()" style="width:100%;padding:10px;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;">æ˜ç™½äº†</button>
                    </div>
                </div>
            `;
            modal.className = 'modal-overlay';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }

        // è®°å½•æŠ•èµ„å»ºè®®
        async function recordRecommendation(symbol, action, confidence) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/reflections/recommendation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol,
                        action,
                        confidence,
                        reasoning: `ç»¼åˆå¤šå› ç´ åˆ†æ: ${action}`,
                        factors: ['ä¸šç»©é¢„æœŸ', 'èµ„é‡‘æµå‘', 'æŠ€æœ¯æŒ‡æ ‡']
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(`âœ“ å·²è®°å½•å»ºè®®: ${symbol} ${action}\n\nç³»ç»Ÿå°†åœ¨æœªæ¥éªŒè¯æ­¤å»ºè®®çš„å‡†ç¡®æ€§ï¼Œå¹¶ç”¨äºæ”¹è¿› AI æ¨¡å‹ã€‚`);
                }
            } catch (e) {
                console.error('è®°å½•å»ºè®®å¤±è´¥:', e);
            }
        }

        // åŠ è½½åæ€æ•°æ®
        async function loadReflectionData(symbol) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/reflections/report`);
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById(`reflection-${symbol}`);
                    if (container) {
                        const accuracy = data.report.summary.accuracy;
                        container.innerHTML = `
                            <div>å†å²å»ºè®®å‡†ç¡®ç‡: <b>${accuracy}</b></div>
                            <div style="margin-top:4px;font-size:10px;color:var(--text-tertiary);">
                                åŸºäº ${data.report.summary.total} æ¡å†å²å»ºè®®çš„è‡ªæˆ‘åæ€
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.error('åŠ è½½åæ€æ•°æ®å¤±è´¥:', e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting data load...');
            loadEarningsCalendar().catch(e => console.error('Earnings load failed:', e));
            loadNewsMonitor().catch(e => console.error('News load failed:', e));
            loadAttributionAnalysis().catch(e => console.error('Attribution load failed:', e));
            loadPriceAlerts().catch(e => console.error('Price alerts load failed:', e));
        });
    </script>
</body>
</html>
